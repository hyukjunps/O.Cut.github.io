<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>인생네컷 키오스크</title>
  <style>
    :root{
      /* 연핑크 + 화이트 */
      --bg:#fff7fb;
      --card:#ffffff;
      --stroke:#f3cde0;
      --text:#2b1b22;
      --muted:#6f5561;
      --pink:#ff6aa8;
      --pink2:#ff9ac4;
      --shadow: 0 18px 55px rgba(31,15,24,.12);

      /* PPT 슬라이드를 PNG로 저장해서 같은 폴더에 template.png로 두기 */
      --tpl: url("template.png");

      /* PPT 남색 박스 4칸 위치(%) */
      --tl-left: 3.54%;
      --tl-top: 17.92%;
      --tr-left: 50.74%;
      --tr-top: 17.92%;
      --bl-left: 3.54%;
      --bl-top: 49.37%;
      --br-left: 50.74%;
      --br-top: 49.37%;
      --slot-w: 46.39%;
      --slot-h: 23.90%;
      --slot-r: 14px;
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 650px at 15% 15%, #ffe6f1 0%, var(--bg) 55%, #ffffff 100%);
    }

    /* ✅ 완전 검은 화면: 텍스트/아이콘/테두리 없음 */
    .blackGate{
      position:fixed;
      inset:0;
      background:#000;
      z-index:99999;
    }

    .app{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .shell{
      width:min(1120px, 96vw);
      background: rgba(255,255,255,.65);
      border:1px solid var(--stroke);
      border-radius:28px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 18px;
      background: linear-gradient(90deg, rgba(255,106,168,.12), rgba(255,255,255,.75));
      border-bottom:1px solid rgba(243,205,224,.75);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:-.4px;
    }
    .heart{
      width:14px; height:14px;
      background: radial-gradient(circle at 30% 30%, #fff 0%, #ffd2e6 40%, #ff6aa8 100%);
      border-radius:6px;
      transform: rotate(45deg);
      box-shadow: 0 0 0 8px rgba(255,106,168,.10);
    }
    .status{color:var(--muted); font-size:13px; font-weight:700;}

    /* 화면 전환 */
    .screen{display:none; padding:18px;}
    .screen.active{display:block;}

    .panel{
      background: rgba(255,255,255,.86);
      border:1px solid rgba(243,205,224,.9);
      border-radius:24px;
      padding:18px;
      box-shadow: 0 10px 30px rgba(31,15,24,.06);
    }

    .btn{
      border:1px solid rgba(255,106,168,.40);
      background: rgba(255,255,255,.90);
      color:var(--text);
      padding:16px 20px;
      border-radius:18px;
      cursor:pointer;
      font-weight:900;
      font-size:16px;
      letter-spacing:-.2px;
      user-select:none;
    }
    .btn:active{transform: translateY(1px);}
    .btn.primary{
      background: linear-gradient(180deg, rgba(255,106,168,.95), rgba(255,154,196,.95));
      color:#fff;
      border-color: rgba(255,106,168,.65);
      box-shadow: 0 14px 28px rgba(255,106,168,.22);
    }
    .btn.danger{
      border-color: rgba(236,72,153,.35);
      background: rgba(236,72,153,.10);
    }

    /* START: 버튼 없이 "클릭하여 시작" */
    .startFill{
      min-height: calc(92vh - 64px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .startCard{
      width:min(860px, 96vw);
      text-align:center;
      padding:46px 22px;
      border-radius:28px;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(243,205,224,.95);
      box-shadow: 0 18px 55px rgba(31,15,24,.10);
      cursor:pointer;
      user-select:none;
    }
    .titleHuge{
      margin:0;
      font-size:64px;
      line-height:1.02;
      letter-spacing:-1.6px;
      font-weight:950;
    }
    @media (max-width: 680px){
      .titleHuge{font-size:46px;}
    }
    .subSmall{
      margin:14px 0 0;
      color: rgba(111,85,97,.88);
      font-weight:800;
      letter-spacing:-.2px;
    }
    .subSmall span{
      display:inline-block;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,106,168,.10);
      border:1px solid rgba(243,205,224,.95);
    }
    .glowLine{
      width:min(520px, 92%);
      height:1px;
      margin:22px auto 0;
      background: linear-gradient(90deg, transparent, rgba(255,106,168,.55), transparent);
    }

    /* SHOOT */
    .shootGrid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .shootGrid{grid-template-columns:1fr;}
    }
    .videoWrap{
      border-radius:24px;
      overflow:hidden;
      border:1px solid rgba(243,205,224,.9);
      background:#000;
      position:relative;
      min-height:360px;
    }
    video{
      width:100%;
      height:100%;
      display:block;
      object-fit:cover;
      transform: scaleX(-1);
    }
    .hud{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .hudTop{
      position:absolute; left:14px; top:14px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .pill{
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.72);
      border:1px solid rgba(243,205,224,.95);
      color: rgba(43,27,34,.90);
      font-size:13px;
      font-weight:900;
    }
    .count{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size:110px;
      font-weight:950;
      color:#fff;
      text-shadow: 0 10px 70px rgba(0,0,0,.70);
      opacity:0;
      transition: opacity .12s ease;
    }
    .count.show{opacity:1;}

    .thumbGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .thumb{
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(243,205,224,.95);
      background: linear-gradient(180deg, #fff, #ffeaf3);
      aspect-ratio: 4/3;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(111,85,97,.85);
      font-weight:900;
      font-size:13px;
      text-align:center;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}

    .ctrlRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    /* RESULT */
    .resultGrid{
      display:grid;
      grid-template-columns: 1fr .8fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .resultGrid{grid-template-columns:1fr;}
    }
    .stage{
      width:100%;
      aspect-ratio: 1356/2048;
      border-radius:24px;
      overflow:hidden;
      border:1px solid rgba(243,205,224,.95);
      background: var(--tpl) center/cover no-repeat, #fff;
      box-shadow: 0 18px 55px rgba(31,15,24,.10);
      position:relative;
    }
    .slot{
      position:absolute;
      border-radius: var(--slot-r);
      overflow:hidden;
      background:#0b2a5b;
    }
    .slot img{width:100%; height:100%; object-fit:cover; display:block;}
    #slot1{ left:var(--tl-left); top:var(--tl-top); width:var(--slot-w); height:var(--slot-h); }
    #slot2{ left:var(--tr-left); top:var(--tr-top); width:var(--slot-w); height:var(--slot-h); }
    #slot3{ left:var(--bl-left); top:var(--bl-top); width:var(--slot-w); height:var(--slot-h); }
    #slot4{ left:var(--br-left); top:var(--br-top); width:var(--slot-w); height:var(--slot-h); }

    .info h2{margin:0 0 8px; letter-spacing:-.4px;}
    .info p{margin:0; color:var(--muted); line-height:1.65; font-weight:650;}
    .info .hint{margin-top:10px; font-size:12.5px; color: rgba(111,85,97,.88);}

    canvas{display:none;}
  </style>
</head>
<body>

  <!-- ✅ 키 입력 전: 진짜 아무것도 없는 검은 화면 -->
  <div class="blackGate" id="blackGate" aria-hidden="true"></div>

  <div class="app">
    <div class="shell">
      <div class="topbar">
        <div class="brand"><span class="heart"></span>인생네컷 (기념일)</div>
        <div class="status" id="status">대기</div>
      </div>

      <!-- START -->
      <section class="screen active" id="screenStart">
        <div class="startFill">
          <div class="startCard" id="tapToStart" role="button" tabindex="0" aria-label="클릭하여 시작">
            <h1 class="titleHuge">오늘의<br/>인생네컷</h1>
            <div class="glowLine"></div>
            <p class="subSmall"><span>화면을 클릭하시면 시작됩니다.</span></p>
          </div>
        </div>
      </section>

      <!-- SHOOT -->
      <section class="screen" id="screenShoot">
        <div class="shootGrid">
          <div class="panel videoWrap">
            <video id="video" playsinline autoplay muted></video>
            <div class="hud">
              <div class="hudTop">
                <div class="pill" id="pillStep">촬영 1 / 4</div>
                <div class="pill" id="pillMsg">타이머 진행 중</div>
              </div>
              <div class="count" id="countdown">3</div>
            </div>
          </div>

          <div>
            <div class="panel">
              <div style="font-weight:950; margin-bottom:10px; letter-spacing:-.2px;">미리보기</div>
              <div class="thumbGrid" id="thumbGrid">
                <div class="thumb" data-i="0">1번</div>
                <div class="thumb" data-i="1">2번</div>
                <div class="thumb" data-i="2">3번</div>
                <div class="thumb" data-i="3">4번</div>
              </div>

              <div class="ctrlRow">
                <button class="btn danger" id="btnCancel">취소</button>
                <button class="btn" id="btnRetake" disabled>전체 다시찍기</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- RESULT -->
      <section class="screen" id="screenResult">
        <div class="resultGrid">
          <div class="stage" id="stage">
            <div class="slot" id="slot1"><img alt=""></div>
            <div class="slot" id="slot2"><img alt=""></div>
            <div class="slot" id="slot3"><img alt=""></div>
            <div class="slot" id="slot4"><img alt=""></div>
          </div>

          <div class="panel info">
            <h2>최종본</h2>
            <p>프레임 + 4장 사진이 합성된 최종본을 저장할 수 있어요.</p>
            <div class="hint">“PNG로 저장”을 누르면 파일이 내려받아집니다.</div>

            <div class="ctrlRow" style="margin-top:14px;">
              <button class="btn" id="btnBack">다시 찍기</button>
              <button class="btn primary" id="btnSave">PNG로 저장</button>
              <button class="btn danger" id="btnHome">처음으로</button>
            </div>
          </div>
        </div>
      </section>

      <canvas id="exportCanvas"></canvas>
    </div>
  </div>

  <script>
    // ===== 화면 전환 =====
    const statusEl = document.getElementById('status');
    const screens = {
      start: document.getElementById('screenStart'),
      shoot: document.getElementById('screenShoot'),
      result: document.getElementById('screenResult'),
    };
    function show(name){
      Object.values(screens).forEach(s => s.classList.remove('active'));
      screens[name].classList.add('active');
      statusEl.textContent = name === 'start' ? '대기' : (name === 'shoot' ? '촬영 중' : '최종본');
    }

    // ===== ✅ 검은 화면: 키 입력 시 해제(텍스트 없음) =====
    const blackGate = document.getElementById('blackGate');
    window.addEventListener('keydown', () => { blackGate.style.display = 'none'; }, { once:true });

    // ===== 촬영/저장 =====
    const tapToStart = document.getElementById('tapToStart');

    const video = document.getElementById('video');
    const countdownEl = document.getElementById('countdown');
    const pillStep = document.getElementById('pillStep');
    const pillMsg  = document.getElementById('pillMsg');

    const btnCancel = document.getElementById('btnCancel');
    const btnRetake = document.getElementById('btnRetake');

    const btnBack = document.getElementById('btnBack');
    const btnSave = document.getElementById('btnSave');
    const btnHome = document.getElementById('btnHome');

    const thumbs = [...document.querySelectorAll('.thumb')];
    const slotImgs = [
      document.querySelector('#slot1 img'),
      document.querySelector('#slot2 img'),
      document.querySelector('#slot3 img'),
      document.querySelector('#slot4 img'),
    ];
    const exportCanvas = document.getElementById('exportCanvas');

    let stream = null;
    let shots = [null,null,null,null];
    let running = false;
    let aborter = null;

    const COUNTDOWN_SEC = 3;
    const BETWEEN_MS = 900;

    function setCountdownVisible(v){ countdownEl.classList.toggle('show', v); }
    function setCountdownText(t){ countdownEl.textContent = String(t); }

    function setThumb(i){
      const el = thumbs[i];
      el.innerHTML = '';
      if(!shots[i]){ el.textContent = `${i+1}번`; return; }
      const im = new Image();
      im.src = shots[i];
      el.appendChild(im);
    }
    function resetShots(){
      shots = [null,null,null,null];
      for(let i=0;i<4;i++){
        setThumb(i);
        slotImgs[i].removeAttribute('src');
      }
      btnRetake.disabled = true;
    }
    function updateResultSlots(){
      for(let i=0;i<4;i++){
        if(shots[i]) slotImgs[i].src = shots[i];
      }
    }

    async function openCamera(){
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
    }
    function closeCamera(){
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      video.srcObject = null;
    }
    const sleep = (ms) => new Promise(r=>setTimeout(r, ms));

    function captureFrame(){
      const vw = video.videoWidth || 1280;
      const vh = video.videoHeight || 720;

      const targetW = 1400;
      const targetH = 1050;

      const srcAspect = vw / vh;
      const dstAspect = targetW / targetH;

      let sx=0, sy=0, sw=vw, sh=vh;
      if(srcAspect > dstAspect){
        sw = Math.round(vh * dstAspect);
        sx = Math.round((vw - sw)/2);
      }else{
        sh = Math.round(vw / dstAspect);
        sy = Math.round((vh - sh)/2);
      }

      const c = document.createElement('canvas');
      c.width = targetW; c.height = targetH;
      const ctx = c.getContext('2d');

      // 미러링 동일 저장
      ctx.save();
      ctx.translate(targetW, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, targetW, targetH);
      ctx.restore();

      return c.toDataURL('image/jpeg', 0.92);
    }

    async function runAutoShoot(){
      if(running) return;
      running = true;
      btnRetake.disabled = true;

      aborter = new AbortController();
      const signal = aborter.signal;

      try{
        for(let i=0;i<4;i++){
          if(signal.aborted) throw new Error('aborted');

          pillStep.textContent = `촬영 ${i+1} / 4`;
          pillMsg.textContent = `타이머 ${COUNTDOWN_SEC}초`;

          for(let t=COUNTDOWN_SEC; t>=1; t--){
            if(signal.aborted) throw new Error('aborted');
            setCountdownText(t);
            setCountdownVisible(true);
            await sleep(700);
          }
          setCountdownVisible(false);

          pillMsg.textContent = '찰칵!';
          shots[i] = captureFrame();
          setThumb(i);

          await sleep(BETWEEN_MS);
        }

        pillMsg.textContent = '촬영 완료';
        btnRetake.disabled = false;

        updateResultSlots();
        show('result');

      } finally {
        running = false;
      }
    }

    function cancelShoot(){
      if(aborter) aborter.abort();
      aborter = null;
      running = false;
    }

    // ===== PNG 합성/저장 =====
    const pctToNum = (v) => parseFloat(v) / 100.0;

    function getSlotRectsInPx(w, h){
      const css = getComputedStyle(document.documentElement);
      const sw = pctToNum(css.getPropertyValue('--slot-w'));
      const sh = pctToNum(css.getPropertyValue('--slot-h'));
      const slots = [
        { left:pctToNum(css.getPropertyValue('--tl-left')), top:pctToNum(css.getPropertyValue('--tl-top')) },
        { left:pctToNum(css.getPropertyValue('--tr-left')), top:pctToNum(css.getPropertyValue('--tr-top')) },
        { left:pctToNum(css.getPropertyValue('--bl-left')), top:pctToNum(css.getPropertyValue('--bl-top')) },
        { left:pctToNum(css.getPropertyValue('--br-left')), top:pctToNum(css.getPropertyValue('--br-top')) },
      ];
      return slots.map(s => ({
        x: Math.round(s.left * w),
        y: Math.round(s.top  * h),
        w: Math.round(sw * w),
        h: Math.round(sh * h),
      }));
    }

    function loadImage(src){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('image load fail'));
        img.src = src;
      });
    }

    function drawCover(ctx, img, dx, dy, dw, dh){
      const iw = img.width, ih = img.height;
      const ir = iw/ih, dr = dw/dh;

      let sx=0, sy=0, sw=iw, sh=ih;
      if(ir > dr){
        sw = Math.round(ih * dr);
        sx = Math.round((iw - sw)/2);
      }else{
        sh = Math.round(iw / dr);
        sy = Math.round((ih - sh)/2);
      }
      ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh);
    }

    async function exportPNG(){
      if(!shots.every(Boolean)){
        alert('4장 모두 촬영되어야 저장할 수 있어요.');
        return;
      }

      let tpl;
      try{
        tpl = await loadImage('template.png');
      }catch(e){
        alert('template.png를 같은 폴더에 두고 다시 시도해줘.');
        return;
      }

      exportCanvas.width = tpl.width;
      exportCanvas.height = tpl.height;
      const ctx = exportCanvas.getContext('2d');

      ctx.drawImage(tpl, 0, 0);

      const imgs = await Promise.all(shots.map(s => loadImage(s)));
      const rects = getSlotRectsInPx(tpl.width, tpl.height);
      for(let i=0;i<4;i++){
        const r = rects[i];
        drawCover(ctx, imgs[i], r.x, r.y, r.w, r.h);
      }

      const blob = await new Promise(res => exportCanvas.toBlob(res, 'image/png'));
      if(!blob){ alert('저장 실패(브라우저 제한)'); return; }

      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = `wedding_4cut_${Date.now()}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ===== 시작(클릭) =====
    async function startFlow(){
      resetShots();
      show('shoot');
      try{
        await openCamera();
      }catch(e){
        alert('웹캠 권한이 필요하거나 HTTPS/localhost가 아닐 수 있어요.\n\n' + e.message);
        show('start');
        return;
      }
      runAutoShoot();
    }

    tapToStart.addEventListener('click', startFlow);
    tapToStart.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); startFlow(); }
    });

    // 버튼 동작
    btnCancel.addEventListener('click', () => {
      cancelShoot();
      closeCamera();
      show('start');
    });

    btnRetake.addEventListener('click', () => {
      cancelShoot();
      resetShots();
      runAutoShoot();
    });

    btnBack.addEventListener('click', async () => {
      cancelShoot();
      resetShots();
      show('shoot');
      try{
        if(!stream) await openCamera();
        runAutoShoot();
      }catch(e){
        alert('웹캠을 다시 열 수 없어요.\n\n' + e.message);
        closeCamera();
        show('start');
      }
    });

    btnSave.addEventListener('click', exportPNG);

    btnHome.addEventListener('click', () => {
      cancelShoot();
      closeCamera();
      resetShots();
      show('start');
    });

    // 초기
    resetShots();
    show('start');
  </script>
</body>
</html>
