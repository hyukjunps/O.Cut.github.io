<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>오늘의 인생네컷</title>
  <style>
    :root{
      --bg:#fff7fb;
      --card:#ffffff;
      --stroke:#f3cde0;
      --text:#2b1b22;
      --muted:#6f5561;
      --pink:#ff6aa8;
      --pink2:#ff9ac4;
      --shadow: 0 18px 55px rgba(31,15,24,.12);

      /* 프레임 경로 (필요하면 assets/template.png 로 변경) */
      --frame-url: "template.png";

      /* 사진 4칸 위치(%) */
      --tl-left: 3.54%;
      --tl-top: 17.92%;
      --tr-left: 50.74%;
      --tr-top: 17.92%;
      --bl-left: 3.54%;
      --bl-top: 49.37%;
      --br-left: 50.74%;
      --br-top: 49.37%;
      --slot-w: 46.39%;
      --slot-h: 23.90%;
      --slot-r: 14px;
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      color:var(--text);
      background: radial-gradient(1100px 800px at 15% 15%, #ffe6f1 0%, var(--bg) 55%, #ffffff 100%);
      overflow:hidden;
    }

    /* 키 입력 전: 완전 검은 화면 */
    .blackGate{position:fixed; inset:0; background:#000; z-index:99999;}

    .app{height:100%; width:100%; display:flex; flex-direction:column;}
    .topbar{
      height:72px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 22px;
      background: linear-gradient(90deg, rgba(255,106,168,.14), rgba(255,255,255,.85));
      border-bottom:1px solid rgba(243,205,224,.9);
    }
    .brand{display:flex; align-items:center; gap:12px; font-weight:950; letter-spacing:-.6px; font-size:18px;}
    .heart{
      width:16px; height:16px;
      background: radial-gradient(circle at 30% 30%, #fff 0%, #ffd2e6 40%, #ff6aa8 100%);
      border-radius:6px;
      transform: rotate(45deg);
      box-shadow: 0 0 0 10px rgba(255,106,168,.10);
    }
    .status{color:var(--muted); font-size:14px; font-weight:850;}
    .main{flex:1; min-height:0;}
    .screen{display:none; height:100%; padding:20px;}
    .screen.active{display:block;}

    .panel{
      height:100%;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(243,205,224,.95);
      border-radius:28px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* START */
    .startCard{
      height:100%;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      cursor:pointer; user-select:none;
      background:
        radial-gradient(900px 700px at 70% 30%, rgba(255,154,196,.22) 0%, rgba(255,255,255,0) 55%),
        radial-gradient(900px 700px at 20% 70%, rgba(255,106,168,.14) 0%, rgba(255,255,255,0) 55%);
    }
    .titleHuge{
      margin:0;
      font-size:min(10vw, 92px);
      line-height:1.02;
      letter-spacing:-2px;
      font-weight:1000;
    }
    .glowLine{
      width:min(680px, 78vw);
      height:2px;
      margin:18px auto 0;
      background: linear-gradient(90deg, transparent, rgba(255,106,168,.65), transparent);
      border-radius:99px;
    }
    .subSmall{
      margin:14px 0 0;
      color: rgba(111,85,97,.90);
      font-weight:900;
      font-size:min(2.6vw, 18px);
    }
    .subSmall span{
      display:inline-block;
      padding:10px 14px;
      border-radius:999px;
      background: rgba(255,106,168,.10);
      border:1px solid rgba(243,205,224,.95);
    }

    /* INFO */
    .infoCard{
      height:100%;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      padding:24px;
      background:
        radial-gradient(900px 700px at 20% 30%, rgba(255,154,196,.20) 0%, rgba(255,255,255,0) 55%),
        radial-gradient(900px 700px at 80% 70%, rgba(255,106,168,.12) 0%, rgba(255,255,255,0) 55%);
    }
    .infoBox{
      width:min(820px, 92vw);
      background: rgba(255,255,255,.90);
      border:1px solid rgba(243,205,224,.95);
      border-radius:26px;
      padding:26px 22px;
      box-shadow: 0 18px 55px rgba(31,15,24,.08);
    }
    .infoBox h2{margin:0 0 10px; font-size:min(4.2vw, 34px); letter-spacing:-1px; font-weight:1000;}
    .infoBox p{margin:0; color: rgba(111,85,97,.92); font-weight:850; font-size:min(2.8vw, 18px); line-height:1.65;}
    .infoTimer{margin-top:16px; font-weight:1000; font-size:min(6vw, 46px); letter-spacing:-1px;}

    /* SHOOT */
    .shootGrid{
      height:100%;
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .shootGrid{grid-template-columns:1fr;}
    }
    .videoWrap{
      border-radius:26px;
      overflow:hidden;
      border:1px solid rgba(243,205,224,.95);
      background:#000;
      position:relative;
      height:100%;
    }
    video{
      width:100%; height:100%;
      display:block;
      object-fit:cover;
      transform: scaleX(-1);
    }
    .hud{position:absolute; inset:0; pointer-events:none;}
    .hudTop{position:absolute; left:16px; top:16px; display:flex; gap:10px; flex-wrap:wrap;}
    .pill{
      padding:10px 14px;
      border-radius:999px;
      background: rgba(255,255,255,.76);
      border:1px solid rgba(243,205,224,.95);
      font-size:14px;
      font-weight:1000;
    }
    .count{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size:min(18vw, 140px);
      font-weight:1000;
      color:#fff;
      text-shadow: 0 10px 70px rgba(0,0,0,.70);
      opacity:0;
      transition: opacity .12s ease;
    }
    .count.show{opacity:1;}

    .side{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .thumbPanel{
      flex:1;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(243,205,224,.95);
      border-radius:26px;
      padding:16px;
      overflow:hidden;
    }
    .thumbTitle{font-weight:1000; letter-spacing:-.3px; margin-bottom:12px; font-size:18px;}
    .thumbGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .thumb{
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(243,205,224,.95);
      background: linear-gradient(180deg, #fff, #ffeaf3);
      aspect-ratio: 4/3;
      display:flex; align-items:center; justify-content:center;
      color: rgba(111,85,97,.85);
      font-weight:1000;
      font-size:14px;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}

    .btnRow{display:flex; gap:12px; flex-wrap:wrap;}
    .btn{
      flex:1;
      min-width:160px;
      border:1px solid rgba(255,106,168,.40);
      background: rgba(255,255,255,.92);
      padding:18px 18px;
      border-radius:20px;
      cursor:pointer;
      font-weight:1000;
      font-size:16px;
      letter-spacing:-.2px;
      user-select:none;
    }
    .btn:active{transform: translateY(1px);}
    .btn.primary{
      background: linear-gradient(180deg, rgba(255,106,168,.95), rgba(255,154,196,.95));
      color:#fff;
      border-color: rgba(255,106,168,.65);
      box-shadow: 0 14px 28px rgba(255,106,168,.22);
    }
    .btn.danger{
      border-color: rgba(236,72,153,.35);
      background: rgba(236,72,153,.10);
    }

    /* RESULT */
    .resultGrid{
      height:100%;
      display:grid;
      grid-template-columns: 1fr .7fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .resultGrid{grid-template-columns:1fr;}
    }
    .stage{
      height:100%;
      border-radius:26px;
      overflow:hidden;
      border:1px solid rgba(243,205,224,.95);
      background: rgba(255,255,255,.88);
      box-shadow: 0 18px 55px rgba(31,15,24,.08);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
    }

    /* ✅ 마지막 화면: 프레임을 항상 "이미지 레이어"로 표시 */
    .frameWrap{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .frameBox{
      width:min(92%, calc((100vh - 72px - 40px) * (1356/2048)));
      height:auto;
      aspect-ratio: 1356/2048;
      position:relative;
      border-radius:22px;
      overflow:hidden;
      background:#fff;
      border:1px solid rgba(243,205,224,.95);
      box-shadow: 0 18px 55px rgba(31,15,24,.08);
    }
    .frameImg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      pointer-events:none;
      user-select:none;
      z-index:3; /* 사진 위 */
    }
    .photosLayer{
      position:absolute;
      inset:0;
      z-index:2; /* 프레임 아래 */
    }

    .slot{
      position:absolute;
      border-radius: var(--slot-r);
      overflow:hidden;
      background:#0b2a5b;
    }
    .slot img{width:100%; height:100%; object-fit:cover; display:block;}
    #slot1{ left:var(--tl-left); top:var(--tl-top); width:var(--slot-w); height:var(--slot-h); }
    #slot2{ left:var(--tr-left); top:var(--tr-top); width:var(--slot-w); height:var(--slot-h); }
    #slot3{ left:var(--bl-left); top:var(--bl-top); width:var(--slot-w); height:var(--slot-h); }
    #slot4{ left:var(--br-left); top:var(--br-top); width:var(--slot-w); height:var(--slot-h); }

    .infoPanel{
      height:100%;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(243,205,224,.95);
      border-radius:26px;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .infoPanel h2{margin:0; font-weight:1000; letter-spacing:-.5px; font-size:24px;}
    .infoPanel p{margin:0; color: rgba(111,85,97,.92); font-weight:850; line-height:1.65;}

    canvas{display:none;}
  </style>
</head>
<body>

  <div class="blackGate" id="blackGate" aria-hidden="true"></div>

  <div class="app">
    <div class="topbar">
      <div class="brand"><span class="heart"></span>인생네컷</div>
      <div class="status" id="status">대기</div>
    </div>

    <div class="main">
      <!-- START -->
      <section class="screen active" id="screenStart">
        <div class="panel startCard" id="tapToStart" role="button" tabindex="0" aria-label="클릭하여 시작">
          <div>
            <h1 class="titleHuge">오늘의<br/>인생네컷</h1>
            <div class="glowLine"></div>
            <p class="subSmall"><span>화면을 클릭하시면 시작됩니다.</span></p>
          </div>
        </div>
      </section>

      <!-- INFO -->
      <section class="screen" id="screenInfo">
        <div class="panel infoCard">
          <div class="infoBox">
            <h2>촬영 안내</h2>
            <p><b>10초마다</b> 사진을 한 장씩 찍습니다.<br/>총 <b>4장</b>이 자동으로 촬영됩니다.</p>
            <div class="infoTimer" id="infoTimer">3</div>
          </div>
        </div>
      </section>

      <!-- SHOOT -->
      <section class="screen" id="screenShoot">
        <div class="shootGrid">
          <div class="videoWrap">
            <video id="video" playsinline autoplay muted></video>
            <div class="hud">
              <div class="hudTop">
                <div class="pill" id="pillStep">촬영 1 / 4</div>
                <div class="pill" id="pillMsg">10초 뒤 촬영</div>
              </div>
              <div class="count" id="countdown">10</div>
            </div>
          </div>

          <div class="side">
            <div class="thumbPanel">
              <div class="thumbTitle">미리보기</div>
              <div class="thumbGrid">
                <div class="thumb" data-i="0">1번</div>
                <div class="thumb" data-i="1">2번</div>
                <div class="thumb" data-i="2">3번</div>
                <div class="thumb" data-i="3">4번</div>
              </div>
            </div>

            <div class="btnRow">
              <button class="btn danger" id="btnCancel">취소</button>
              <button class="btn" id="btnRetake" disabled>전체 다시찍기</button>
            </div>
          </div>
        </div>
      </section>

      <!-- RESULT -->
      <section class="screen" id="screenResult">
        <div class="resultGrid">
          <div class="stage">
            <div class="frameWrap">
              <div class="frameBox" id="frameBox">
                <!-- 사진 레이어 -->
                <div class="photosLayer" id="photosLayer">
                  <div class="slot" id="slot1"><img alt=""></div>
                  <div class="slot" id="slot2"><img alt=""></div>
                  <div class="slot" id="slot3"><img alt=""></div>
                  <div class="slot" id="slot4"><img alt=""></div>
                </div>
                <!-- ✅ 프레임 레이어(항상 보임) -->
                <img class="frameImg" id="frameImg" alt="" />
              </div>
            </div>
          </div>

          <div class="infoPanel">
            <h2>최종본</h2>
            <p>프레임이 적용된 최종본을 저장할 수 있어요.</p>

            <div class="btnRow" style="margin-top:8px;">
              <button class="btn" id="btnBack">다시 찍기</button>
              <button class="btn primary" id="btnSave">PNG로 저장</button>
              <button class="btn danger" id="btnHome">처음으로</button>
            </div>
          </div>
        </div>
      </section>

      <canvas id="exportCanvas"></canvas>
    </div>
  </div>

  <script>
    // 화면 전환
    const statusEl = document.getElementById('status');
    const screens = {
      start: document.getElementById('screenStart'),
      info: document.getElementById('screenInfo'),
      shoot: document.getElementById('screenShoot'),
      result: document.getElementById('screenResult'),
    };
    function show(name){
      Object.values(screens).forEach(s => s.classList.remove('active'));
      screens[name].classList.add('active');
      statusEl.textContent = name === 'start' ? '대기' : (name === 'info' ? '안내' : (name === 'shoot' ? '촬영 중' : '최종본'));
    }

    // 검은 화면: 키 입력 시 해제
    const blackGate = document.getElementById('blackGate');
    window.addEventListener('keydown', () => { blackGate.style.display = 'none'; }, { once:true });

    // DOM
    const tapToStart = document.getElementById('tapToStart');
    const infoTimerEl = document.getElementById('infoTimer');

    const video = document.getElementById('video');
    const countdownEl = document.getElementById('countdown');
    const pillStep = document.getElementById('pillStep');
    const pillMsg  = document.getElementById('pillMsg');

    const btnCancel = document.getElementById('btnCancel');
    const btnRetake = document.getElementById('btnRetake');
    const btnBack   = document.getElementById('btnBack');
    const btnSave   = document.getElementById('btnSave');
    const btnHome   = document.getElementById('btnHome');

    const thumbs = [...document.querySelectorAll('.thumb')];
    const slotImgs = [
      document.querySelector('#slot1 img'),
      document.querySelector('#slot2 img'),
      document.querySelector('#slot3 img'),
      document.querySelector('#slot4 img'),
    ];

    // ✅ 프레임을 마지막 화면에 항상 표시
    const frameImg = document.getElementById('frameImg');
    const exportCanvas = document.getElementById('exportCanvas');

    // 상태
    let stream = null;
    let shots = [null,null,null,null];
    let aborter = null;
    let running = false;

    const INTERVAL_SEC = 10;
    const TOTAL_SHOTS = 4;

    // 프레임 로드(마지막 화면용)
    const framePath = getComputedStyle(document.documentElement)
      .getPropertyValue('--frame-url')
      .trim()
      .replace(/^"|"$/g,'');
    frameImg.src = framePath;

    function setCountdownVisible(v){ countdownEl.classList.toggle('show', v); }
    function setCountdownText(t){ countdownEl.textContent = String(t); }

    function setThumb(i){
      const el = thumbs[i];
      el.innerHTML = '';
      if(!shots[i]){ el.textContent = `${i+1}번`; return; }
      const im = new Image();
      im.src = shots[i];
      el.appendChild(im);
    }

    function resetShots(){
      shots = Array(TOTAL_SHOTS).fill(null);
      for(let i=0;i<TOTAL_SHOTS;i++){
        setThumb(i);
        slotImgs[i].removeAttribute('src');
      }
      btnRetake.disabled = true;
    }

    function updateResultSlots(){
      for(let i=0;i<TOTAL_SHOTS;i++){
        if(shots[i]) slotImgs[i].src = shots[i];
      }
    }

    async function openCamera(){
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
    }

    function closeCamera(){
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      video.srcObject = null;
    }

    const sleep = (ms) => new Promise(r=>setTimeout(r, ms));

    function captureFrame(){
      const vw = video.videoWidth || 1280;
      const vh = video.videoHeight || 720;

      const targetW = 1400;
      const targetH = 1050;

      const srcAspect = vw / vh;
      const dstAspect = targetW / targetH;

      let sx=0, sy=0, sw=vw, sh=vh;
      if(srcAspect > dstAspect){
        sw = Math.round(vh * dstAspect);
        sx = Math.round((vw - sw)/2);
      }else{
        sh = Math.round(vw / dstAspect);
        sy = Math.round((vh - sh)/2);
      }

      const c = document.createElement('canvas');
      c.width = targetW; c.height = targetH;
      const ctx = c.getContext('2d');

      ctx.save();
      ctx.translate(targetW, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, targetW, targetH);
      ctx.restore();

      return c.toDataURL('image/jpeg', 0.92);
    }

    async function run10sIntervalShoot(){
      if(running) return;
      running = true;
      btnRetake.disabled = true;

      aborter = new AbortController();
      const signal = aborter.signal;

      try{
        for(let i=0;i<TOTAL_SHOTS;i++){
          if(signal.aborted) throw new Error('aborted');

          pillStep.textContent = `촬영 ${i+1} / ${TOTAL_SHOTS}`;

          for(let t=INTERVAL_SEC; t>=1; t--){
            if(signal.aborted) throw new Error('aborted');
            pillMsg.textContent = `${t}초 뒤 촬영`;
            setCountdownText(t);
            setCountdownVisible(true);
            await sleep(1000);
          }
          setCountdownVisible(false);

          pillMsg.textContent = '찰칵!';
          shots[i] = captureFrame();
          setThumb(i);

          await sleep(300);
        }

        pillMsg.textContent = '촬영 완료';
        btnRetake.disabled = false;

        updateResultSlots();
        show('result');
      } finally {
        running = false;
      }
    }

    function cancelShoot(){
      if(aborter) aborter.abort();
      aborter = null;
      running = false;
    }

    // 안내 화면 3초
    async function showInfoThenShoot(){
      show('info');
      for(let t=3; t>=1; t--){
        infoTimerEl.textContent = String(t);
        await sleep(700);
      }
      infoTimerEl.textContent = 'START';
      await sleep(400);

      show('shoot');
      try{
        await openCamera();
      }catch(e){
        alert('웹캠 권한이 필요하거나 HTTPS/localhost가 아닐 수 있어요.');
        show('start');
        return;
      }
      run10sIntervalShoot();
    }

    // PNG 저장(프레임 + 4장 합성)
    const pctToNum = (v) => parseFloat(v) / 100.0;

    function getSlotRectsInPx(w, h){
      const css = getComputedStyle(document.documentElement);
      const sw = pctToNum(css.getPropertyValue('--slot-w'));
      const sh = pctToNum(css.getPropertyValue('--slot-h'));
      const slots = [
        { left:pctToNum(css.getPropertyValue('--tl-left')), top:pctToNum(css.getPropertyValue('--tl-top')) },
        { left:pctToNum(css.getPropertyValue('--tr-left')), top:pctToNum(css.getPropertyValue('--tr-top')) },
        { left:pctToNum(css.getPropertyValue('--bl-left')), top:pctToNum(css.getPropertyValue('--bl-top')) },
        { left:pctToNum(css.getPropertyValue('--br-left')), top:pctToNum(css.getPropertyValue('--br-top')) },
      ];
      return slots.map(s => ({
        x: Math.round(s.left * w),
        y: Math.round(s.top  * h),
        w: Math.round(sw * w),
        h: Math.round(sh * h),
      }));
    }

    function loadImage(src){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('image load fail'));
        img.src = src;
      });
    }

    function drawCover(ctx, img, dx, dy, dw, dh){
      const iw = img.width, ih = img.height;
      const ir = iw/ih, dr = dw/dh;

      let sx=0, sy=0, sw=iw, sh=ih;
      if(ir > dr){
        sw = Math.round(ih * dr);
        sx = Math.round((iw - sw)/2);
      }else{
        sh = Math.round(iw / dr);
        sy = Math.round((ih - sh)/2);
      }
      ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh);
    }

    async function exportPNG(){
      if(!shots.every(Boolean)){
        alert('촬영이 완료되지 않았어요.');
        return;
      }

      let tpl;
      try{
        tpl = await loadImage(framePath);
      }catch(e){
        alert('프레임 이미지를 못 찾았어요.');
        return;
      }

      exportCanvas.width = tpl.width;
      exportCanvas.height = tpl.height;
      const ctx = exportCanvas.getContext('2d');

      // 1) 사진 먼저
      const imgs = await Promise.all(shots.map(s => loadImage(s)));
      const rects = getSlotRectsInPx(tpl.width, tpl.height);
      for(let i=0;i<TOTAL_SHOTS;i++){
        const r = rects[i];
        drawCover(ctx, imgs[i], r.x, r.y, r.w, r.h);
      }

      // 2) 프레임을 위에 덮기 (✅ 저장 결과도 프레임이 위로)
      ctx.drawImage(tpl, 0, 0);

      const blob = await new Promise(res => exportCanvas.toBlob(res, 'image/png'));
      if(!blob){ alert('저장 실패'); return; }

      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = `4cut_${Date.now()}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // 시작
    async function startFlow(){
      resetShots();
      await showInfoThenShoot();
    }

    tapToStart.addEventListener('click', startFlow);
    tapToStart.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); startFlow(); }
    });

    // 버튼
    btnCancel.addEventListener('click', () => {
      cancelShoot();
      closeCamera();
      show('start');
    });

    btnRetake.addEventListener('click', () => {
      cancelShoot();
      resetShots();
      run10sIntervalShoot();
    });

    btnBack.addEventListener('click', async () => {
      cancelShoot();
      resetShots();
      show('shoot');
      try{
        if(!stream) await openCamera();
        run10sIntervalShoot();
      }catch(e){
        closeCamera();
        show('start');
      }
    });

    btnSave.addEventListener('click', exportPNG);

    btnHome.addEventListener('click', () => {
      cancelShoot();
      closeCamera();
      resetShots();
      show('start');
    });

    // 초기
    resetShots();
    show('start');
  </script>
</body>
</html>
