<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>오늘 네컷 · O.cut</title>
  <style>
    :root{
      --bg1:#fff1f7;
      --bg2:#ffffff;
      --card: rgba(255,255,255,.92);
      --stroke:#f3cde0;
      --text:#2b1b22;
      --muted:#6f5561;

      --pri:#7c3aed;        /* O.Poong 계열 보라 */
      --pri2:#5b21b6;
      --pink:#ff4fa3;
      --pink2:#ff9ac4;

      --shadow: 0 28px 90px rgba(31,15,24,.14);
      --shadow2: 0 18px 60px rgba(31,15,24,.10);

      /* ✅ 프레임 */
      --frame-url: "template1.png";

      /* 슬롯(프레임마다 동일한 위치라고 가정) */
      --tl-left: 3.54%;
      --tl-top: 17.92%;
      --tr-left: 50.74%;
      --tr-top: 17.92%;
      --bl-left: 3.54%;
      --bl-top: 49.37%;
      --br-left: 50.74%;
      --br-top: 49.37%;
      --slot-w: 46.39%;
      --slot-h: 23.90%;
      --slot-r: 18px;

      /* ✅ 필터(미리보기용) */
      --preview-filter: none;
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      color:var(--text);
      overflow:hidden;
      touch-action: manipulation;
      background:
        radial-gradient(1200px 900px at 18% 18%, rgba(124,58,237,.14) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(1200px 900px at 82% 82%, rgba(255,79,163,.18) 0%, rgba(255,255,255,0) 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    /* ===== KIOSK LAYOUT ===== */
    .app{height:100dvh; width:100vw; display:flex; flex-direction:column;}
    .topbar{
      height:92px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 clamp(18px, 2.2vw, 30px);
      background:
        linear-gradient(90deg, rgba(124,58,237,.14), rgba(255,79,163,.12), rgba(255,255,255,.92));
      border-bottom:1px solid rgba(243,205,224,.95);
      backdrop-filter: blur(12px);
      flex:0 0 auto;
    }
    .brand{
      display:flex; align-items:center; gap:14px;
      font-weight:1000; letter-spacing:-.9px;
      font-size:22px;
    }
    .logo{
      width:20px; height:20px;
      border-radius:8px;
      background: radial-gradient(circle at 30% 30%, #fff 0%, #e9ddff 35%, var(--pri) 100%);
      box-shadow: 0 0 0 12px rgba(124,58,237,.10), 0 14px 40px rgba(124,58,237,.14);
      transform: rotate(12deg);
    }
    .brand b{font-size:24px;}
    .brand small{
      display:block;
      font-size:13px;
      letter-spacing:-.2px;
      color: rgba(111,85,97,.80);
      font-weight:950;
      margin-top:2px;
      line-height:1.1;
    }

    .status{
      color: rgba(43,27,34,.86);
      font-size:16px;
      font-weight:1000;
      display:flex; align-items:center; gap:10px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(124,58,237,.92);
      box-shadow: 0 0 0 9px rgba(124,58,237,.12);
    }

    .main{flex:1; min-height:0;}
    .screen{display:none; height:100%; padding:clamp(14px, 2.2vw, 24px);}
    .screen.active{display:block;}

    .panel{
      height:100%;
      background: var(--card);
      border:1px solid rgba(243,205,224,.95);
      border-radius:34px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    /* ===== BIG KIOSK BUTTONS ===== */
    .cta{
      border:none;
      cursor:pointer;
      border-radius:26px;
      padding:26px 24px;
      font-weight:1000;
      font-size:22px;
      letter-spacing:-.2px;
      user-select:none;
      transition: transform .08s ease, filter .18s ease;
      min-height: 78px;
    }
    .cta.primary{
      background: linear-gradient(180deg, rgba(124,58,237,.98), rgba(91,33,182,.98));
      color:#fff;
      box-shadow: 0 22px 60px rgba(124,58,237,.20);
    }
    .cta.pink{
      background: linear-gradient(180deg, rgba(255,79,163,.98), rgba(255,154,196,.98));
      color:#fff;
      box-shadow: 0 22px 60px rgba(255,79,163,.18);
    }
    .cta.ghost{
      background: rgba(255,255,255,.92);
      border:1px solid rgba(124,58,237,.28);
      color:var(--text);
      box-shadow: var(--shadow2);
    }
    .cta.danger{
      background: rgba(255,79,163,.08);
      border:1px solid rgba(255,79,163,.25);
      color:var(--text);
      box-shadow: var(--shadow2);
    }
    .cta:active{transform: translateY(2px) scale(.99);}
    .cta:disabled{opacity:.55; cursor:not-allowed; filter: grayscale(.2);}

    /* ===== START (Attract) ===== */
    .startCard{
      height:100%;
      display:grid;
      place-items:center;
      text-align:center;
      user-select:none;
      background:
        radial-gradient(1200px 900px at 75% 22%, rgba(255,79,163,.16) 0%, rgba(255,255,255,0) 62%),
        radial-gradient(1200px 900px at 20% 82%, rgba(124,58,237,.18) 0%, rgba(255,255,255,0) 62%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.0));
    }
    .glow{
      position:absolute; inset:-50%;
      background:
        radial-gradient(closest-side at 30% 40%, rgba(124,58,237,.16), rgba(255,255,255,0) 70%),
        radial-gradient(closest-side at 70% 60%, rgba(255,79,163,.14), rgba(255,255,255,0) 70%);
      filter: blur(30px);
      animation: drift 6.5s ease-in-out infinite alternate;
      pointer-events:none;
    }
    @keyframes drift{
      from{transform: translate3d(-2%, -1%, 0) scale(1.02);}
      to{transform: translate3d(2%, 1%, 0) scale(1.05);}
    }

    .startInner{width:min(1040px, 94vw); padding: clamp(18px, 3vw, 36px); position:relative;}
    .heroTop{
      display:flex; align-items:center; justify-content:center; gap:12px;
      margin-bottom: 8px;
    }
    .heroBadge{
      display:inline-flex; align-items:center; gap:10px;
      padding: 12px 16px;
      border-radius:999px;
      background: rgba(124,58,237,.10);
      border:1px solid rgba(124,58,237,.18);
      font-weight:1000;
      color: rgba(43,27,34,.92);
      font-size: 16px;
      letter-spacing:-.2px;
      box-shadow: 0 14px 40px rgba(124,58,237,.10);
    }
    .pulseDot{
      width:12px; height:12px; border-radius:999px;
      background: rgba(255,79,163,.95);
      box-shadow: 0 0 0 0 rgba(255,79,163,.32);
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse{
      0%{box-shadow: 0 0 0 0 rgba(255,79,163,.32);}
      70%{box-shadow: 0 0 0 16px rgba(255,79,163,0);}
      100%{box-shadow: 0 0 0 0 rgba(255,79,163,0);}
    }

    .startTitle{
      margin:0;
      font-size: clamp(60px, 7.6vw, 120px);
      line-height:1.0;
      letter-spacing:-2.8px;
      font-weight:1000;
      background: linear-gradient(90deg, rgba(124,58,237,1), rgba(255,79,163,1));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      filter: drop-shadow(0 18px 55px rgba(31,15,24,.12));
    }
    .startSub{
      margin:18px 0 0;
      color: rgba(111,85,97,.92);
      font-weight:950;
      font-size: clamp(18px, 2.2vw, 28px);
      letter-spacing:-.3px;
    }
    .startHint{
      margin:18px 0 0;
      display:inline-flex;
      align-items:center;
      gap:12px;
      padding:16px 20px;
      border-radius:999px;
      background: rgba(255,255,255,.72);
      border:1px solid rgba(243,205,224,.95);
      font-weight:1000;
      font-size: clamp(16px, 1.9vw, 22px);
      box-shadow: var(--shadow2);
    }

    .startButtons{
      margin-top: 28px;
      display:flex;
      justify-content:center;
      gap:16px;
      flex-wrap:wrap;
    }
    .bigStart{
      width: min(680px, 92vw);
      font-size: 26px;
      padding: 30px 28px;
      border-radius: 28px;
      position: relative;
      overflow:hidden;
    }
    .bigStart::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.34), rgba(255,255,255,0) 55%);
      transform: rotate(18deg);
      animation: shine 2.4s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes shine{
      0%{transform: translateX(-22%) rotate(18deg); opacity:.65;}
      50%{transform: translateX(22%) rotate(18deg); opacity:.85;}
      100%{transform: translateX(-22%) rotate(18deg); opacity:.65;}
    }

    .smallNote{
      margin-top:14px;
      color: rgba(111,85,97,.78);
      font-weight:900;
      font-size: 14px;
    }

    /* ===== INFO ===== */
    .infoCard{
      height:100%;
      display:grid;
      place-items:center;
      text-align:center;
      padding: clamp(18px, 3vw, 30px);
      background:
        radial-gradient(1200px 900px at 20% 25%, rgba(124,58,237,.14) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(1200px 900px at 80% 75%, rgba(255,79,163,.12) 0%, rgba(255,255,255,0) 60%);
    }
    .infoBox{
      width:min(900px, 94vw);
      background: rgba(255,255,255,.94);
      border:1px solid rgba(243,205,224,.95);
      border-radius:32px;
      padding: clamp(24px, 3vw, 40px);
      box-shadow: var(--shadow2);
    }
    .infoBox h2{
      margin:0 0 10px;
      font-size: clamp(34px, 3.6vw, 52px);
      letter-spacing:-1.2px;
      font-weight:1000;
    }
    .infoBox p{
      margin:0;
      color: rgba(111,85,97,.92);
      font-weight:900;
      font-size: clamp(18px, 2.2vw, 26px);
      line-height:1.65;
    }
    .infoTimer{
      margin-top:18px;
      font-weight:1000;
      font-size: clamp(66px, 7.4vw, 96px);
      color: rgba(43,27,34,.95);
      letter-spacing:-2px;
    }

    /* ===== SHOOT ===== */
    .shootGrid{
      height:100%;
      display:grid;
      grid-template-columns: 1.55fr .80fr;
      gap:18px;
    }
    @media (max-width: 980px){ .shootGrid{grid-template-columns:1fr;} }

    .videoWrap{
      border-radius:34px;
      overflow:hidden;
      border:1px solid rgba(243,205,224,.95);
      background:#000;
      position:relative;
      min-height:0;
      height:100%;
      box-shadow: var(--shadow2);
    }
    video{
      width:100%;
      height:100%;
      display:block;
      object-fit:cover;
      transform: scaleX(-1);
      filter: var(--preview-filter);
    }

    .flash{
      position:absolute; inset:0;
      background:#fff;
      opacity:0;
      pointer-events:none;
      z-index:3;
    }
    .flash.on{ animation: flash 240ms ease-out; }
    @keyframes flash{ 0%{opacity:0} 10%{opacity:.95} 100%{opacity:0} }

    .hud{position:absolute; inset:0; pointer-events:none; z-index:4;}
    .hudTop{position:absolute; left:18px; top:18px; display:flex; gap:12px; flex-wrap:wrap;}
    .pill{
      padding:12px 16px;
      border-radius:999px;
      background: rgba(255,255,255,.82);
      border:1px solid rgba(243,205,224,.95);
      color: rgba(43,27,34,.92);
      font-size:16px;
      font-weight:1000;
      letter-spacing:-.2px;
      box-shadow: 0 12px 40px rgba(31,15,24,.08);
    }
    .count{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size: clamp(96px, 14vw, 170px);
      font-weight:1000;
      color:#fff;
      text-shadow: 0 12px 80px rgba(0,0,0,.70);
      opacity:0;
      transform: scale(.96);
      transition: opacity .12s ease, transform .12s ease;
    }
    .count.show{opacity:1; transform: scale(1);}

    .toast{
      position:absolute;
      left:50%; bottom:26px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.94);
      border:1px solid rgba(243,205,224,.95);
      border-radius:999px;
      padding:16px 20px;
      font-weight:1000;
      letter-spacing:-.2px;
      box-shadow: var(--shadow2);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:5;
      font-size: 18px;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-8px);}

    .side{height:100%; display:flex; flex-direction:column; gap:18px;}
    .cardBox{
      background: rgba(255,255,255,.94);
      border:1px solid rgba(243,205,224,.95);
      border-radius:34px;
      padding:18px;
      overflow:hidden;
      box-shadow: var(--shadow2);
    }

    .thumbTitle{font-weight:1000; letter-spacing:-.4px; margin-bottom:14px; font-size: clamp(18px, 2vw, 22px);}
    .thumbGrid{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    .thumb{
      border-radius:20px;
      overflow:hidden;
      border:1px solid rgba(243,205,224,.95);
      background: linear-gradient(180deg, #fff, #f6f1ff);
      aspect-ratio: 4/3;
      display:flex; align-items:center; justify-content:center;
      color: rgba(111,85,97,.85);
      font-weight:1000;
      font-size: clamp(14px, 1.6vw, 18px);
      text-align:center;
      position:relative;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block; filter: var(--preview-filter);}
    .btnRow{display:flex; gap:14px; flex-wrap:wrap;}
    .btnRow .cta{flex:1; min-width: 210px;}

    /* ===== RESULT ===== */
    .resultGrid{
      height:100%;
      display:grid;
      grid-template-columns: 1fr .78fr;
      gap:18px;
    }
    @media (max-width: 980px){ .resultGrid{grid-template-columns:1fr;} }

    .stage{
      height:100%;
      border-radius:34px;
      overflow:hidden;
      border:1px solid rgba(243,205,224,.95);
      background: rgba(255,255,255,.94);
      box-shadow: var(--shadow2);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: clamp(10px, 1.8vw, 16px);
    }
    .frame{
      width:100%;
      height:100%;
      max-width: min(100%, calc((100dvh - 92px - 48px) * (1356/2048)));
      max-height: 100%;
      aspect-ratio: 1356/2048;
      border-radius:26px;
      overflow:hidden;
      position:relative;
      background: url(var(--frame-url)) center/cover no-repeat, #fff;
      border:1px solid rgba(243,205,224,.95);
      box-shadow: 0 22px 90px rgba(31,15,24,.12);
      transform: translateZ(0);
    }

    .slot{position:absolute; z-index:2; border-radius: var(--slot-r); overflow:hidden; background:transparent;}
    .slot img{width:100%; height:100%; object-fit:cover; display:block; filter: var(--preview-filter);}
    #slot1{ left:var(--tl-left); top:var(--tl-top); width:var(--slot-w); height:var(--slot-h); }
    #slot2{ left:var(--tr-left); top:var(--tr-top); width:var(--slot-w); height:var(--slot-h); }
    #slot3{ left:var(--bl-left); top:var(--bl-top); width:var(--slot-w); height:var(--slot-h); }
    #slot4{ left:var(--br-left); top:var(--br-top); width:var(--slot-w); height:var(--slot-h); }

    .overlayText{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      bottom: 4.2%;
      z-index: 4;
      color:#111;
      font-weight: 1000;
      letter-spacing: -.4px;
      text-align:center;
      font-size: clamp(16px, 2.2vw, 28px);
      text-shadow: 0 6px 18px rgba(255,255,255,.55);
      padding: 12px 16px;
      border-radius: 18px;
      background: rgba(255,255,255,.66);
      border: 1px solid rgba(243,205,224,.95);
      backdrop-filter: blur(10px);
      max-width: 92%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      pointer-events: none;
      user-select:none;
    }

    .infoPanel{
      height:100%;
      background: rgba(255,255,255,.94);
      border:1px solid rgba(243,205,224,.95);
      border-radius:34px;
      padding: 20px;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-height: 260px;
      box-shadow: var(--shadow2);
      overflow:auto;
    }
    .infoPanel h2{
      margin:0;
      font-weight:1000;
      letter-spacing:-.6px;
      font-size: clamp(26px, 2.6vw, 34px);
    }
    .infoPanel p{
      margin:0;
      color: rgba(111,85,97,.92);
      font-weight:900;
      line-height:1.65;
      font-size: clamp(16px, 1.9vw, 20px);
    }

    .field{
      display:flex; flex-direction:column; gap:10px;
      padding: 14px 14px;
      border-radius: 22px;
      border: 1px solid rgba(243,205,224,.95);
      background: rgba(255,255,255,.76);
      box-shadow: 0 14px 40px rgba(31,15,24,.06);
    }
    .field label{
      font-weight: 1000;
      letter-spacing:-.3px;
      color: rgba(43,27,34,.92);
      font-size: 14px;
    }
    .row2{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    .control{
      height: 58px;
      border-radius: 18px;
      border: 1px solid rgba(124,58,237,.22);
      background: rgba(255,255,255,.92);
      padding: 0 14px;
      font-weight: 1000;
      font-size: 18px;
      outline: none;
    }
    .control:focus{box-shadow: 0 0 0 4px rgba(124,58,237,.14);}
    .smallHelp{
      margin-top:-4px;
      color: rgba(111,85,97,.78);
      font-weight: 900;
      font-size: 12px;
      line-height: 1.35;
    }

    /* ===== FILTER PICKER ===== */
    .filterGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 980px){ .filterGrid{grid-template-columns: repeat(2, 1fr);} }
    .filterBtn{
      border:1px solid rgba(243,205,224,.95);
      background: rgba(255,255,255,.92);
      border-radius: 18px;
      padding: 12px 12px;
      cursor:pointer;
      font-weight:1000;
      text-align:left;
      box-shadow: 0 12px 36px rgba(31,15,24,.06);
      transition: transform .08s ease, box-shadow .18s ease;
      min-height: 66px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .filterBtn:active{transform: translateY(2px) scale(.99);}
    .filterBtn .tag{
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(124,58,237,.10);
      border: 1px solid rgba(124,58,237,.18);
      font-size: 12px;
      white-space:nowrap;
    }
    .filterBtn.active{
      border-color: rgba(124,58,237,.42);
      box-shadow: 0 18px 48px rgba(124,58,237,.14);
    }

    /* ===== MODAL / ERROR ===== */
    .modal{
      position:fixed; inset:0;
      display:none;
      place-items:center;
      background: rgba(15,8,16,.42);
      backdrop-filter: blur(10px);
      z-index: 999;
      padding: 18px;
    }
    .modal.show{display:grid;}
    .modalCard{
      width: min(860px, 96vw);
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(243,205,224,.95);
      border-radius: 34px;
      box-shadow: var(--shadow);
      padding: 24px;
      text-align:center;
    }
    .modalCard h3{
      margin:0;
      font-size: clamp(26px, 3vw, 42px);
      letter-spacing:-1px;
      font-weight:1000;
    }
    .modalCard p{
      margin: 10px 0 0;
      color: rgba(111,85,97,.92);
      font-weight:900;
      font-size: clamp(16px, 2vw, 22px);
      line-height: 1.6;
    }
    .modalCard .mono{
      margin-top: 14px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(124,58,237,.08);
      border: 1px solid rgba(124,58,237,.18);
      border-radius: 18px;
      padding: 12px;
      font-size: 14px;
      font-weight: 950;
      color: rgba(43,27,34,.92);
      text-align:left;
      overflow:auto;
      max-height: 160px;
    }

    canvas{display:none;}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <span class="logo"></span>
        <div>
          <b>오늘 네컷</b>
          <small>O.cut</small>
        </div>
      </div>
      <div class="status" id="status"><span class="dot"></span>대기</div>
    </div>

    <div class="main">
      <!-- START -->
      <section class="screen active" id="screenStart">
        <div class="panel startCard" id="tapToStart" role="button" tabindex="0" aria-label="터치하여 시작">
          <div class="glow"></div>
          <div class="startInner">
            <div class="heroTop">
              <div class="heroBadge"><span class="pulseDot"></span>키오스크 모드 · 터치로 시작</div>
            </div>
            <h1 class="startTitle">오늘 네컷</h1>
            <p class="startSub">10초마다 4장 자동 촬영 · 프레임/필터/문구 편집</p>
            <div class="startHint">화면을 터치(클릭)하면 촬영이 시작됩니다</div>

            <div class="startButtons">
              <button class="cta primary bigStart" id="btnStart" type="button">시작하기</button>
              <button class="cta ghost" id="btnTestFrames" type="button" style="width:min(320px, 92vw);">프레임 점검</button>
            </div>

            <div class="smallNote">
              카메라가 열리지 않으면 관리자에게 문의하세요.
            </div>
          </div>
        </div>
      </section>

      <!-- INFO -->
      <section class="screen" id="screenInfo">
        <div class="panel infoCard">
          <div class="infoBox">
            <h2>촬영 안내</h2>
            <p>
              10초마다 사진을 한 장씩 촬영합니다.<br/>
              총 4장 촬영 후 프레임, 필터, 문구를 선택해 저장합니다.
            </p>
            <div class="infoTimer" id="infoTimer">3</div>
          </div>
        </div>
      </section>

      <!-- SHOOT -->
      <section class="screen" id="screenShoot">
        <div class="shootGrid">
          <div class="videoWrap" id="videoWrap">
            <video id="video" playsinline autoplay muted></video>
            <div class="flash" id="flash"></div>

            <div class="hud">
              <div class="hudTop">
                <div class="pill" id="pillStep">촬영 1 / 4</div>
                <div class="pill" id="pillMsg">10초 뒤 촬영</div>
              </div>
              <div class="count" id="countdown">10</div>
            </div>
            <div class="toast" id="toast">안내</div>
          </div>

          <div class="side">
            <div class="cardBox">
              <div class="thumbTitle">미리보기</div>
              <div class="thumbGrid" id="thumbGrid">
                <div class="thumb" data-i="0">1번</div>
                <div class="thumb" data-i="1">2번</div>
                <div class="thumb" data-i="2">3번</div>
                <div class="thumb" data-i="3">4번</div>
              </div>
            </div>

            <div class="btnRow">
              <button class="cta danger" id="btnCancel" type="button">취소</button>
              <button class="cta ghost" id="btnRetake" type="button" disabled>전체 다시찍기</button>
            </div>
          </div>
        </div>
      </section>

      <!-- RESULT -->
      <section class="screen" id="screenResult">
        <div class="resultGrid">
          <div class="stage">
            <div class="frame" id="frame">
              <div class="slot" id="slot1"><img alt=""></div>
              <div class="slot" id="slot2"><img alt=""></div>
              <div class="slot" id="slot3"><img alt=""></div>
              <div class="slot" id="slot4"><img alt=""></div>
              <div class="overlayText" id="overlayText">오늘 네컷 · O.cut</div>
            </div>
          </div>

          <div class="infoPanel">
            <h2>편집 · 저장</h2>
            <p>원하는 프레임과 필터를 선택하고 문구를 입력하세요.</p>

            <!-- 프레임 -->
            <div class="field">
              <label for="frameSelect">프레임</label>
              <select class="control" id="frameSelect">
                <option value="template1.png">프레임 1</option>
                <option value="template2.png">프레임 2</option>
                <option value="template3.png">프레임 3</option>
                <option value="template4.png">프레임 4</option>
                <option value="template5.png">프레임 5</option>
              </select>
              <div class="smallHelp" id="frameHealth">프레임 준비 상태를 확인 중…</div>
            </div>

            <!-- 필터 -->
            <div class="field">
              <label>사진 필터</label>
              <div class="filterGrid" id="filterGrid"></div>
              <div class="smallHelp">선택한 필터는 미리보기와 저장 파일에 모두 적용됩니다.</div>
            </div>

            <!-- 문구 -->
            <div class="field">
              <label for="textInput">문구(하단)</label>
              <input class="control" id="textInput" type="text" maxlength="40" placeholder="예) Poongsan High School · 2026.02.22" />
              <div class="row2" style="margin-top:10px;">
                <div>
                  <label for="textSize" style="display:block; margin-bottom:8px; font-weight:1000; font-size:14px;">글씨 크기</label>
                  <input class="control" id="textSize" type="number" min="12" max="46" value="22" />
                </div>
                <div>
                  <label for="textPos" style="display:block; margin-bottom:8px; font-weight:1000; font-size:14px;">아래 여백(%)</label>
                  <input class="control" id="textPos" type="number" min="1" max="18" value="4.2" step="0.1" />
                </div>
              </div>
            </div>

            <div class="btnRow" style="margin-top:6px;">
              <button class="cta ghost" id="btnBack" type="button">다시 찍기</button>
              <button class="cta primary" id="btnSave" type="button">PNG로 저장</button>
              <button class="cta danger" id="btnHome" type="button">처음으로</button>
            </div>

            <div style="margin-top:auto; color:rgba(111,85,97,.78); font-weight:900; font-size:14px;" id="autoHomeHint">
              저장 후 60초 동안 입력이 없으면 자동으로 처음 화면으로 이동합니다.
            </div>
          </div>
        </div>
      </section>

      <canvas id="exportCanvas"></canvas>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal" id="modal">
    <div class="modalCard">
      <h3 id="modalTitle">오류</h3>
      <p id="modalMsg">문제가 발생했습니다. 관리자에게 문의하세요.</p>
      <div class="mono" id="modalDetail" style="display:none;"></div>
      <div style="margin-top:18px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
        <button class="cta primary" id="modalOk" type="button" style="width:min(420px, 92vw);">확인</button>
      </div>
    </div>
  </div>

  <script>
    // ===== 화면 전환 =====
    const statusEl = document.getElementById('status');
    const screens = {
      start: document.getElementById('screenStart'),
      info: document.getElementById('screenInfo'),
      shoot: document.getElementById('screenShoot'),
      result: document.getElementById('screenResult'),
    };
    function show(name){
      Object.values(screens).forEach(s => s.classList.remove('active'));
      screens[name].classList.add('active');
      const label = name === 'start' ? '대기' : name === 'info' ? '안내' : name === 'shoot' ? '촬영 중' : '편집/저장';
      statusEl.innerHTML = `<span class="dot"></span>${label}`;
      bumpIdleTimer();
    }

    // ===== MODAL =====
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMsg = document.getElementById('modalMsg');
    const modalDetail = document.getElementById('modalDetail');
    const modalOk = document.getElementById('modalOk');

    function openModal(title, msg, detail){
      modalTitle.textContent = title || '오류';
      modalMsg.textContent = msg || '문제가 발생했습니다. 관리자에게 문의하세요.';
      if(detail){
        modalDetail.style.display = 'block';
        modalDetail.textContent = String(detail);
      }else{
        modalDetail.style.display = 'none';
        modalDetail.textContent = '';
      }
      modal.classList.add('show');
      speak('오류가 발생했습니다. 관리자에게 문의하세요.');
    }
    function closeModal(){ modal.classList.remove('show'); }
    modalOk.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

    // ===== DOM =====
    const tapToStart = document.getElementById('tapToStart');
    const btnStart = document.getElementById('btnStart');
    const btnTestFrames = document.getElementById('btnTestFrames');
    const infoTimerEl = document.getElementById('infoTimer');

    const video = document.getElementById('video');
    const countdownEl = document.getElementById('countdown');
    const pillStep = document.getElementById('pillStep');
    const pillMsg  = document.getElementById('pillMsg');

    const btnCancel = document.getElementById('btnCancel');
    const btnRetake = document.getElementById('btnRetake');
    const btnBack   = document.getElementById('btnBack');
    const btnSave   = document.getElementById('btnSave');
    const btnHome   = document.getElementById('btnHome');

    const flashEl = document.getElementById('flash');
    const videoWrap = document.getElementById('videoWrap');
    const toastEl = document.getElementById('toast');

    const thumbs = [...document.querySelectorAll('.thumb')];
    const slotImgs = [
      document.querySelector('#slot1 img'),
      document.querySelector('#slot2 img'),
      document.querySelector('#slot3 img'),
      document.querySelector('#slot4 img'),
    ];

    const frameEl = document.getElementById('frame');
    const slotEls = [
      document.getElementById('slot1'),
      document.getElementById('slot2'),
      document.getElementById('slot3'),
      document.getElementById('slot4'),
    ];
    const exportCanvas = document.getElementById('exportCanvas');

    // 편집 UI
    const frameSelect = document.getElementById('frameSelect');
    const frameHealth = document.getElementById('frameHealth');

    const filterGrid = document.getElementById('filterGrid');
    const textInput   = document.getElementById('textInput');
    const textSize    = document.getElementById('textSize');
    const textPos     = document.getElementById('textPos');
    const overlayText = document.getElementById('overlayText');

    // ===== 상태 =====
    let stream = null;
    let shots = [null,null,null,null]; // 원본(필터 미적용) dataURL
    let aborter = null;
    let running = false;

    const INTERVAL_SEC = 10;
    const TOTAL_SHOTS = 4;

    // 결과 화면 자동 홈(키오스크)
    const AUTO_HOME_MS = 60_000;
    let idleTimer = null;
    function bumpIdleTimer(){
      if(idleTimer) clearTimeout(idleTimer);
      if(screens.result.classList.contains('active')){
        idleTimer = setTimeout(()=> goHome('자동으로 처음 화면으로 이동합니다.'), AUTO_HOME_MS);
      }
    }
    ['pointerdown','keydown','mousemove','touchstart'].forEach(ev=>{
      window.addEventListener(ev, ()=> bumpIdleTimer(), {passive:true});
    });

    // ===== 유틸 =====
    const sleep = (ms) => new Promise(r=>setTimeout(r, ms));
    function setCountdownVisible(v){ countdownEl.classList.toggle('show', v); }
    function setCountdownText(t){ countdownEl.textContent = String(t); }

    function toast(msg, ms=900){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>toastEl.classList.remove('show'), ms);
    }

    // ===== TTS =====
    let ttsEnabled = true;
    function speak(text){
      if(!ttsEnabled) return;
      if(!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ko-KR';
      u.rate = 1.0;
      u.pitch = 1.0;
      u.volume = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }

    // ===== 필터 정의 =====
    const FILTERS = [
      { id:'none',  name:'기본',   css:'none',                                                tag:'원본' },
      { id:'bw',    name:'흑백',   css:'grayscale(1) contrast(1.06)',                         tag:'B/W' },
      { id:'sepia', name:'세피아', css:'sepia(0.85) contrast(1.05) saturate(1.15)',           tag:'Vintage' },
      { id:'cool',  name:'쿨톤',   css:'saturate(1.12) contrast(1.06) hue-rotate(330deg)',     tag:'Cool' },
      { id:'warm',  name:'웜톤',   css:'saturate(1.14) contrast(1.05) hue-rotate(12deg)',     tag:'Warm' },
      { id:'vivid', name:'비비드', css:'saturate(1.45) contrast(1.12)',                       tag:'Vivid' },
      { id:'soft',  name:'소프트', css:'saturate(0.95) contrast(0.98) brightness(1.06)',      tag:'Soft' },
    ];

    let selectedFilter = FILTERS[0]; // 기본

    function renderFilterButtons(){
      filterGrid.innerHTML = '';
      FILTERS.forEach(f=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'filterBtn' + (f.id === selectedFilter.id ? ' active' : '');
        btn.innerHTML = `<div>${f.name}</div><div class="tag">${f.tag}</div>`;
        btn.addEventListener('click', ()=>{
          selectedFilter = f;
          applyPreviewFilter();
          [...filterGrid.querySelectorAll('.filterBtn')].forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          toast('필터 적용됨', 700);
        });
        filterGrid.appendChild(btn);
      });
    }

    function applyPreviewFilter(){
      document.documentElement.style.setProperty('--preview-filter', selectedFilter.css);
      // 캡처된 이미지 미리보기도 즉시 반영(CSS 필터)
    }

    // ===== 프레임 점검 =====
    const frameFiles = ['template1.png','template2.png','template3.png','template4.png','template5.png'];
    const frameOK = new Map(); // filename -> boolean

    function loadImage(src){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('image load fail: ' + src));
        img.src = src;
      });
    }

    async function checkFrames(){
      frameHealth.textContent = '프레임 점검 중…';
      let okCount = 0;
      const missing = [];

      for(const f of frameFiles){
        try{
          await loadImage(f);
          frameOK.set(f, true);
          okCount++;
        }catch(e){
          frameOK.set(f, false);
          missing.push(f);
        }
      }

      // select 옵션 disable 처리
      [...frameSelect.options].forEach(opt=>{
        const f = opt.value;
        const ok = frameOK.get(f);
        opt.disabled = (ok === false);
      });

      if(okCount === 0){
        frameHealth.textContent = '프레임을 찾을 수 없습니다.';
        openModal(
          '프레임 오류',
          '프레임 파일을 찾지 못했습니다. 관리자에게 문의하세요.',
          '누락 파일:\n- ' + missing.join('\n- ')
        );
        return {ok:false, missing};
      }

      if(missing.length){
        frameHealth.textContent = `사용 가능 프레임: ${okCount}개 / 누락: ${missing.length}개`;
      }else{
        frameHealth.textContent = `프레임 준비 완료 (${okCount}개)`;
      }

      // 현재 선택 프레임이 누락이면 첫 OK로 변경
      const current = frameSelect.value;
      if(frameOK.get(current) === false){
        const firstOk = frameFiles.find(x => frameOK.get(x));
        if(firstOk){
          frameSelect.value = firstOk;
          applyFrame(firstOk);
        }
      }
      return {ok:true, missing};
    }

    function applyFrame(path){
      document.documentElement.style.setProperty('--frame-url', `"${path}"`);
    }

    // ===== 미리보기/슬롯 =====
    function setThumb(i){
      const el = thumbs[i];
      el.innerHTML = '';
      if(!shots[i]){ el.textContent = `${i+1}번`; return; }
      const im = new Image();
      im.src = shots[i];
      el.appendChild(im);
    }

    function resetShots(){
      shots = Array(TOTAL_SHOTS).fill(null);
      for(let i=0;i<TOTAL_SHOTS;i++){
        setThumb(i);
        slotImgs[i].removeAttribute('src');
      }
      btnRetake.disabled = true;
    }

    function updateResultSlots(){
      for(let i=0;i<TOTAL_SHOTS;i++){
        if(shots[i]) slotImgs[i].src = shots[i];
      }
    }

    // ===== 문구 오버레이 =====
    function applyText(){
      const txt = (textInput.value || '오늘 네컷 · O.cut').trim();
      overlayText.textContent = txt;

      const px = Math.max(12, Math.min(46, Number(textSize.value) || 22));
      overlayText.style.fontSize = px + 'px';

      const b = Math.max(1, Math.min(18, Number(textPos.value) || 4.2));
      overlayText.style.bottom = b + '%';
    }

    textInput.addEventListener('input', applyText);
    textSize.addEventListener('input', applyText);
    textPos.addEventListener('input', applyText);

    frameSelect.addEventListener('change', async () => {
      const f = frameSelect.value;
      if(frameOK.get(f) === false){
        openModal('프레임 오류', '선택한 프레임을 불러올 수 없습니다. 관리자에게 문의하세요.', f);
        // 가능한 프레임으로 되돌림
        const firstOk = frameFiles.find(x => frameOK.get(x));
        if(firstOk){
          frameSelect.value = firstOk;
          applyFrame(firstOk);
        }
        return;
      }
      applyFrame(f);
      toast('프레임 적용됨', 700);
    });

    // ===== 웹캠 =====
    async function openCamera(){
      const constraints = {
        video: {
          facingMode: "user",
          width: { ideal: 1920 },
          height:{ ideal: 1080 }
        },
        audio: false
      };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
      await waitForVideoReady();
    }

    function closeCamera(){
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      video.srcObject = null;
    }

    async function waitForVideoReady(){
      const start = performance.now();
      while((video.videoWidth === 0 || video.videoHeight === 0) && performance.now()-start < 2500){
        await sleep(50);
      }
      if(video.videoWidth === 0) throw new Error('카메라 영상 준비 실패');
    }

    // ===== 찰칵 효과 =====
    let audioCtx = null;
    function clickBeep(){
      try{
        audioCtx ||= new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'triangle';
        o.frequency.value = 880;
        g.gain.value = 0.0001;
        o.connect(g); g.connect(audioCtx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.14, audioCtx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.12);
        o.stop(audioCtx.currentTime + 0.13);
      }catch(e){}
    }
    function shutterFX(){
      flashEl.classList.remove('on');
      void flashEl.offsetWidth;
      flashEl.classList.add('on');
      videoWrap.animate(
        [{ transform:'scale(1)' }, { transform:'scale(1.018)' }, { transform:'scale(1)' }],
        { duration: 240, easing:'ease-out' }
      );
      clickBeep();
    }

    // ===== 캡처(원본 저장) =====
    function captureFrameRaw(){
      const vw = video.videoWidth;
      const vh = video.videoHeight;

      const targetW = 1400;
      const targetH = 1050;

      const srcAspect = vw / vh;
      const dstAspect = targetW / targetH;

      let sx=0, sy=0, sw=vw, sh=vh;
      if(srcAspect > dstAspect){
        sw = Math.round(vh * dstAspect);
        sx = Math.round((vw - sw)/2);
      }else{
        sh = Math.round(vw / dstAspect);
        sy = Math.round((vh - sh)/2);
      }

      const c = document.createElement('canvas');
      c.width = targetW; c.height = targetH;
      const ctx = c.getContext('2d', { alpha:false });

      ctx.save();
      ctx.translate(targetW, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, targetW, targetH);
      ctx.restore();

      // 원본 저장 (필터는 export에서 적용)
      return c.toDataURL('image/jpeg', 0.92);
    }

    // ===== 촬영 루프 =====
    async function run10sIntervalShoot(){
      if(running) return;
      running = true;
      btnRetake.disabled = true;

      aborter = new AbortController();
      const signal = aborter.signal;

      try{
        for(let i=0;i<TOTAL_SHOTS;i++){
          if(signal.aborted) throw new Error('aborted');

          pillStep.textContent = `촬영 ${i+1} / ${TOTAL_SHOTS}`;
          toast(`${i+1}번째 촬영 준비`, 900);
          speak(`${i+1}번째 사진, 10초 후 촬영합니다.`);

          for(let t=INTERVAL_SEC; t>=1; t--){
            if(signal.aborted) throw new Error('aborted');
            pillMsg.textContent = `${t}초 뒤 촬영`;
            setCountdownText(t);
            setCountdownVisible(true);
            if(t <= 3) speak(String(t));
            await sleep(1000);
          }

          setCountdownVisible(false);
          pillMsg.textContent = '찰칵!';
          toast('찰칵!', 650);
          speak('찰칵');

          shutterFX();
          await sleep(80);

          shots[i] = captureFrameRaw();
          setThumb(i);

          await sleep(320);
        }

        pillMsg.textContent = '촬영 완료';
        toast('촬영 완료! 편집 후 저장하세요.', 1200);
        speak('촬영이 완료되었습니다. 프레임과 필터를 선택하고 저장하세요.');

        btnRetake.disabled = false;

        updateResultSlots();
        show('result');
      } catch(e){
        if(String(e && e.message) !== 'aborted'){
          openModal('촬영 오류', '촬영 중 문제가 발생했습니다. 관리자에게 문의하세요.', e && e.message ? e.message : e);
        }
      } finally {
        running = false;
      }
    }

    function cancelShoot(){
      if(aborter) aborter.abort();
      aborter = null;
      running = false;
    }

    // ===== 안내 화면 =====
    async function showInfoThenShoot(){
      show('info');
      speak('촬영을 시작합니다.');

      for(let t=3; t>=1; t--){
        infoTimerEl.textContent = String(t);
        await sleep(650);
      }
      infoTimerEl.textContent = 'START';
      await sleep(420);

      show('shoot');
      try{
        await openCamera();
      }catch(e){
        openModal(
          '카메라 오류',
          '카메라를 열 수 없습니다. 관리자에게 문의하세요.',
          (e && e.message) ? e.message : e
        );
        show('start');
        return;
      }
      run10sIntervalShoot();
    }

    // ===== PNG 합성/저장 (필터 포함) =====
    function drawCover(ctx, img, dx, dy, dw, dh){
      const iw = img.width, ih = img.height;
      const ir = iw/ih, dr = dw/dh;

      let sx=0, sy=0, sw=iw, sh=ih;
      if(ir > dr){
        sw = Math.round(ih * dr);
        sx = Math.round((iw - sw)/2);
      }else{
        sh = Math.round(iw / dr);
        sy = Math.round((ih - sh)/2);
      }
      ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh);
    }

    function getSlotRectsFromDOM(tplW, tplH){
      const frameR = frameEl.getBoundingClientRect();
      const sx = tplW / frameR.width;
      const sy = tplH / frameR.height;

      return slotEls.map(el=>{
        const r = el.getBoundingClientRect();
        const x = Math.round((r.left - frameR.left) * sx);
        const y = Math.round((r.top  - frameR.top)  * sy);
        const w = Math.round(r.width  * sx);
        const h = Math.round(r.height * sy);
        return {x,y,w,h};
      });
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    async function exportPNG(){
      bumpIdleTimer();
      if(!shots.every(Boolean)){
        openModal('저장 불가', '4장 모두 촬영되어야 저장할 수 있습니다.', '');
        return;
      }

      const framePath = frameSelect.value;
      if(frameOK.get(framePath) === false){
        openModal('프레임 오류', '선택한 프레임을 불러올 수 없습니다. 관리자에게 문의하세요.', framePath);
        return;
      }

      let tpl;
      try{
        tpl = await loadImage(framePath);
      }catch(e){
        openModal('프레임 오류', '프레임 파일을 찾지 못했습니다. 관리자에게 문의하세요.', framePath);
        return;
      }

      exportCanvas.width = tpl.width;
      exportCanvas.height = tpl.height;
      const ctx = exportCanvas.getContext('2d');

      // 1) 프레임
      ctx.filter = 'none';
      ctx.drawImage(tpl, 0, 0);

      // 2) 사진(필터 적용)
      const imgs = await Promise.all(shots.map(s => loadImage(s)));
      const rects = getSlotRectsFromDOM(tpl.width, tpl.height);

      ctx.filter = selectedFilter.css; // ✅ 필터를 캔버스에도 적용
      for(let i=0;i<TOTAL_SHOTS;i++){
        const r = rects[i];
        drawCover(ctx, imgs[i], r.x, r.y, r.w, r.h);
      }
      ctx.filter = 'none';

      // 3) 텍스트 오버레이
      const txt = (textInput.value || '오늘 네컷 · O.cut').trim();
      const fontPx = Math.max(12, Math.min(60, Number(textSize.value) || 22));
      const bottomPct = Math.max(1, Math.min(30, Number(textPos.value) || 4.2));

      const scaledFont = Math.round(fontPx * (tpl.width / 1356));
      ctx.save();
      ctx.font = `1000 ${scaledFont}px system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      const padX = Math.round(scaledFont * 0.95);
      const padY = Math.round(scaledFont * 0.60);
      const x = Math.round(tpl.width * 0.5);
      const y = Math.round(tpl.height * (1 - bottomPct/100));

      const w = Math.ceil(ctx.measureText(txt).width);
      const boxW = Math.min(tpl.width - 90, w + padX*2);
      const boxH = Math.round(scaledFont + padY*1.25);
      const boxX = Math.round(x - boxW/2);
      const boxY = Math.round(y - boxH/2);
      const rr = Math.round(scaledFont * 0.62);

      ctx.fillStyle = 'rgba(255,255,255,0.66)';
      roundRect(ctx, boxX, boxY, boxW, boxH, rr);
      ctx.fill();

      ctx.strokeStyle = 'rgba(243,205,224,0.95)';
      ctx.lineWidth = Math.max(2, Math.round(scaledFont * 0.09));
      roundRect(ctx, boxX, boxY, boxW, boxH, rr);
      ctx.stroke();

      ctx.fillStyle = '#111';
      ctx.shadowColor = 'rgba(255,255,255,0.55)';
      ctx.shadowBlur = Math.round(scaledFont * 0.9);
      ctx.fillText(txt, x, y);
      ctx.restore();

      const blob = await new Promise(res => exportCanvas.toBlob(res, 'image/png'));
      if(!blob){
        openModal('저장 오류', '저장을 진행할 수 없습니다. 관리자에게 문의하세요.', 'canvas toBlob 실패');
        return;
      }

      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = `오늘네컷_Ocut_${Date.now()}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      speak('저장을 시작합니다.');
      toast('저장 완료', 1100);
    }

    // ===== 시작/홈 =====
    async function startFlow(){
      bumpIdleTimer();
      resetShots();
      await showInfoThenShoot();
    }

    function goHome(msg){
      cancelShoot();
      closeCamera();
      resetShots();
      if(msg) toast(msg, 1100);
      show('start');
      speak('처음 화면으로 돌아갑니다.');
    }

    // startCard 전체 클릭 + 버튼 클릭
    tapToStart.addEventListener('click', startFlow);
    btnStart.addEventListener('click', (e)=>{ e.stopPropagation(); startFlow(); });
    tapToStart.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); startFlow(); }
    });

    // ===== 버튼 =====
    btnCancel.addEventListener('click', () => {
      cancelShoot();
      closeCamera();
      speak('촬영을 취소했습니다.');
      show('start');
    });

    btnRetake.addEventListener('click', () => {
      cancelShoot();
      resetShots();
      speak('다시 촬영을 시작합니다.');
      run10sIntervalShoot();
    });

    btnBack.addEventListener('click', async () => {
      cancelShoot();
      resetShots();
      show('shoot');
      try{
        if(!stream) await openCamera();
        speak('다시 촬영을 시작합니다.');
        run10sIntervalShoot();
      }catch(e){
        openModal('카메라 오류', '카메라를 열 수 없습니다. 관리자에게 문의하세요.', (e && e.message) ? e.message : e);
        closeCamera();
        show('start');
      }
    });

    btnSave.addEventListener('click', exportPNG);

    btnHome.addEventListener('click', () => {
      goHome();
    });

    // 프레임 점검 버튼
    btnTestFrames.addEventListener('click', async (e)=>{
      e.stopPropagation();
      const res = await checkFrames();
      if(res.ok){
        if(res.missing && res.missing.length){
          openModal('프레임 점검', '일부 프레임이 누락되었습니다. 관리자에게 문의하세요.', '누락 파일:\n- ' + res.missing.join('\n- '));
        }else{
          openModal('프레임 점검', '프레임이 정상적으로 준비되었습니다.', '');
        }
      }
    });

    // ===== 초기화 =====
    (async function init(){
      resetShots();
      renderFilterButtons();
      applyPreviewFilter();
      applyText();
      show('start');

      // 첫 로드에서 프레임 점검(조용히)
      try{
        await checkFrames();
        applyFrame(frameSelect.value);
      }catch(e){
        // checkFrames 내부에서 모달 처리 가능
      }
    })();
  </script>
</body>
</html>
