<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>오늘의 인생네컷</title>
  <style>
    :root{
      --bg1:#fff1f7;
      --bg2:#ffffff;
      --card: rgba(255,255,255,.90);
      --stroke:#f3cde0;
      --text:#2b1b22;
      --muted:#6f5561;
      --pink:#ff4fa3;
      --pink2:#ff9ac4;
      --shadow: 0 22px 70px rgba(31,15,24,.14);

      /* 프레임 이미지 경로 */
      --frame-url: "template.png";

      /* 화면 프리뷰에서 슬롯 위치(%) */
      --tl-left: 3.54%;
      --tl-top: 17.92%;
      --tr-left: 50.74%;
      --tr-top: 17.92%;
      --bl-left: 3.54%;
      --bl-top: 49.37%;
      --br-left: 50.74%;
      --br-top: 49.37%;
      --slot-w: 46.39%;
      --slot-h: 23.90%;
      --slot-r: 16px;
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 20% 15%, rgba(255,154,196,.35) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(1200px 900px at 80% 85%, rgba(255,79,163,.18) 0%, rgba(255,255,255,0) 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
      touch-action: manipulation;
    }

    /* ✅ 태블릿 풀스크린: 스크롤/여백 방지 */
    .app{height:100dvh; width:100vw; display:flex; flex-direction:column;}
    .topbar{
      height:86px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 clamp(18px, 2.2vw, 28px);
      background: linear-gradient(90deg, rgba(255,79,163,.16), rgba(255,255,255,.92));
      border-bottom:1px solid rgba(243,205,224,.95);
      backdrop-filter: blur(10px);
      flex:0 0 auto;
    }
    .brand{display:flex; align-items:center; gap:14px; font-weight:1000; letter-spacing:-.8px; font-size:22px;}
    .logo{
      width:18px; height:18px;
      background: radial-gradient(circle at 30% 30%, #fff 0%, #ffd2e6 40%, var(--pink) 100%);
      border-radius:7px;
      transform: rotate(45deg);
      box-shadow: 0 0 0 12px rgba(255,79,163,.10);
    }
    .status{color: rgba(111,85,97,.92); font-size:16px; font-weight:950; display:flex; align-items:center; gap:10px;}
    .dot{width:10px; height:10px; border-radius:999px; background: rgba(255,79,163,.85); box-shadow: 0 0 0 8px rgba(255,79,163,.12);}

    .main{flex:1; min-height:0;}
    .screen{display:none; height:100%; padding:clamp(14px, 2.2vw, 24px);}
    .screen.active{display:block;}

    .panel{
      height:100%;
      background: var(--card);
      border:1px solid rgba(243,205,224,.95);
      border-radius:32px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    /* 큰 터치 버튼 */
    .cta{
      border:none;
      cursor:pointer;
      border-radius:22px;
      padding:22px 22px;
      font-weight:1000;
      font-size:20px;
      letter-spacing:-.2px;
      user-select:none;
    }
    .cta.primary{
      background: linear-gradient(180deg, rgba(255,79,163,.98), rgba(255,154,196,.98));
      color:#fff;
      box-shadow: 0 18px 40px rgba(255,79,163,.22);
    }
    .cta.ghost{
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,79,163,.35);
      color:var(--text);
    }
    .cta.danger{
      background: rgba(255,79,163,.10);
      border:1px solid rgba(255,79,163,.30);
      color:var(--text);
    }
    .cta:active{transform: translateY(1px);}
    .cta:disabled{opacity:.55; cursor:not-allowed;}

    /* START */
    .startCard{
      height:100%;
      display:grid;
      place-items:center;
      text-align:center;
      user-select:none;
      background:
        radial-gradient(1100px 820px at 70% 25%, rgba(255,154,196,.28) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(1100px 820px at 25% 80%, rgba(255,79,163,.16) 0%, rgba(255,255,255,0) 60%);
    }
    .startInner{
      width:min(980px, 92vw);
      padding: clamp(18px, 3vw, 30px);
    }
    .startTitle{
      margin:0;
      font-size: clamp(56px, 7.6vw, 112px);
      line-height:1.0;
      letter-spacing:-2.6px;
      font-weight:1000;
    }
    .startSub{
      margin:18px 0 0;
      color: rgba(111,85,97,.92);
      font-weight:950;
      font-size: clamp(18px, 2.2vw, 26px);
      letter-spacing:-.3px;
    }
    .startHint{
      margin:18px 0 0;
      display:inline-flex;
      align-items:center;
      gap:12px;
      padding:14px 18px;
      border-radius:999px;
      background: rgba(255,79,163,.10);
      border:1px solid rgba(243,205,224,.95);
      font-weight:1000;
      font-size: clamp(16px, 1.8vw, 20px);
    }
    .pulse{
      width:12px; height:12px; border-radius:999px;
      background: rgba(255,79,163,.9);
      box-shadow: 0 0 0 0 rgba(255,79,163,.35);
      animation: pulse 1.4s infinite;
    }
    @keyframes pulse{
      0%{box-shadow: 0 0 0 0 rgba(255,79,163,.35);}
      70%{box-shadow: 0 0 0 14px rgba(255,79,163,0);}
      100%{box-shadow: 0 0 0 0 rgba(255,79,163,0);}
    }

    /* INFO */
    .infoCard{
      height:100%;
      display:grid;
      place-items:center;
      text-align:center;
      padding: clamp(18px, 3vw, 30px);
      background:
        radial-gradient(1200px 900px at 20% 25%, rgba(255,154,196,.22) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(1200px 900px at 80% 75%, rgba(255,79,163,.12) 0%, rgba(255,255,255,0) 60%);
    }
    .infoBox{
      width:min(860px, 94vw);
      background: rgba(255,255,255,.92);
      border:1px solid rgba(243,205,224,.95);
      border-radius:30px;
      padding: clamp(22px, 3vw, 34px);
      box-shadow: 0 18px 55px rgba(31,15,24,.08);
    }
    .infoBox h2{margin:0 0 10px; font-size: clamp(30px, 3.5vw, 46px); letter-spacing:-1.2px; font-weight:1000;}
    .infoBox p{margin:0; color: rgba(111,85,97,.92); font-weight:900; font-size: clamp(18px, 2.2vw, 24px); line-height:1.65;}
    .infoTimer{margin-top:18px; font-weight:1000; font-size: clamp(54px, 7vw, 86px); color: rgba(43,27,34,.95); letter-spacing:-2px;}

    /* SHOOT */
    .shootGrid{
      height:100%;
      display:grid;
      grid-template-columns: 1.55fr .75fr;
      gap:18px;
    }
    @media (max-width: 980px){
      .shootGrid{grid-template-columns:1fr;}
    }

    .videoWrap{
      border-radius:30px;
      overflow:hidden;
      border:1px solid rgba(243,205,224,.95);
      background:#000;
      position:relative;
      min-height:0;
      height:100%;
      box-shadow: 0 18px 55px rgba(31,15,24,.08);
    }
    video{
      width:100%;
      height:100%;
      display:block;
      object-fit:cover;
      transform: scaleX(-1);
    }

    .flash{
      position:absolute; inset:0;
      background:#fff;
      opacity:0;
      pointer-events:none;
      z-index:3;
    }
    .flash.on{ animation: flash 240ms ease-out; }
    @keyframes flash{ 0%{opacity:0} 10%{opacity:.95} 100%{opacity:0} }

    .hud{position:absolute; inset:0; pointer-events:none; z-index:4;}
    .hudTop{position:absolute; left:18px; top:18px; display:flex; gap:12px; flex-wrap:wrap;}
    .pill{
      padding:12px 16px;
      border-radius:999px;
      background: rgba(255,255,255,.80);
      border:1px solid rgba(243,205,224,.95);
      color: rgba(43,27,34,.92);
      font-size:16px;
      font-weight:1000;
      letter-spacing:-.2px;
    }
    .count{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size: clamp(88px, 14vw, 160px);
      font-weight:1000;
      color:#fff;
      text-shadow: 0 10px 70px rgba(0,0,0,.70);
      opacity:0;
      transform: scale(.96);
      transition: opacity .12s ease, transform .12s ease;
    }
    .count.show{opacity:1; transform: scale(1);}

    .toast{
      position:absolute;
      left:50%; bottom:24px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.92);
      border:1px solid rgba(243,205,224,.95);
      border-radius:999px;
      padding:14px 18px;
      font-weight:1000;
      letter-spacing:-.2px;
      box-shadow: 0 18px 55px rgba(31,15,24,.10);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:5;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-6px);}

    .side{height:100%; display:flex; flex-direction:column; gap:18px;}
    .thumbPanel{
      flex:1;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(243,205,224,.95);
      border-radius:30px;
      padding:18px;
      overflow:hidden;
      box-shadow: 0 18px 55px rgba(31,15,24,.06);
    }
    .thumbTitle{font-weight:1000; letter-spacing:-.4px; margin-bottom:14px; font-size: clamp(18px, 2vw, 22px);}
    .thumbGrid{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    .thumb{
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(243,205,224,.95);
      background: linear-gradient(180deg, #fff, #ffeaf3);
      aspect-ratio: 4/3;
      display:flex; align-items:center; justify-content:center;
      color: rgba(111,85,97,.85);
      font-weight:1000;
      font-size: clamp(14px, 1.6vw, 18px);
      text-align:center;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .btnRow{display:flex; gap:14px; flex-wrap:wrap;}
    .btnRow .cta{flex:1; min-width: 210px;}

    /* RESULT */
    .resultGrid{
      height:100%;
      display:grid;
      grid-template-columns: 1fr .7fr;
      gap:18px;
    }
    @media (max-width: 980px){
      .resultGrid{grid-template-columns:1fr;}
    }
    .stage{
      height:100%;
      border-radius:30px;
      overflow:hidden;
      border:1px solid rgba(243,205,224,.95);
      background: rgba(255,255,255,.92);
      box-shadow: 0 18px 55px rgba(31,15,24,.08);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: clamp(10px, 1.8vw, 16px);
    }
    .frame{
      width:100%;
      height:100%;
      max-width: min(100%, calc((100dvh - 86px - 48px) * (1356/2048)));
      max-height: 100%;
      aspect-ratio: 1356/2048;
      border-radius:24px;
      overflow:hidden;
      position:relative;
      background: url(var(--frame-url)) center/cover no-repeat, #fff;
      border:1px solid rgba(243,205,224,.95);
    }
    .slot{position:absolute; z-index:2; border-radius: var(--slot-r); overflow:hidden; background:transparent;}
    .slot img{width:100%; height:100%; object-fit:cover; display:block;}
    #slot1{ left:var(--tl-left); top:var(--tl-top); width:var(--slot-w); height:var(--slot-h); }
    #slot2{ left:var(--tr-left); top:var(--tr-top); width:var(--slot-w); height:var(--slot-h); }
    #slot3{ left:var(--bl-left); top:var(--bl-top); width:var(--slot-w); height:var(--slot-h); }
    #slot4{ left:var(--br-left); top:var(--br-top); width:var(--slot-w); height:var(--slot-h); }

    .infoPanel{
      height:100%;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(243,205,224,.95);
      border-radius:30px;
      padding: 20px;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-height: 260px;
      box-shadow: 0 18px 55px rgba(31,15,24,.06);
    }
    .infoPanel h2{margin:0; font-weight:1000; letter-spacing:-.6px; font-size: clamp(24px, 2.6vw, 32px);}
    .infoPanel p{margin:0; color: rgba(111,85,97,.92); font-weight:900; line-height:1.65; font-size: clamp(16px, 1.9vw, 20px);}

    canvas{display:none;}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand"><span class="logo"></span>인생네컷</div>
      <div class="status" id="status"><span class="dot"></span>대기</div>
    </div>

    <div class="main">
      <!-- START -->
      <section class="screen active" id="screenStart">
        <div class="panel startCard" id="tapToStart" role="button" tabindex="0" aria-label="클릭하여 시작">
          <div class="startInner">
            <h1 class="startTitle">오늘의<br/>인생네컷</h1>
            <p class="startSub">결혼기념일 기념 촬영 · 10초마다 4장 자동 촬영</p>
            <div class="startHint"><span class="pulse"></span>화면을 터치(클릭)하면 시작됩니다</div>

            <div style="margin-top:26px; display:flex; justify-content:center;">
              <button class="cta primary" id="btnStart" style="width:min(560px, 92vw); font-size:24px; padding:26px 24px;" type="button">
                시작하기
              </button>
            </div>
            <div style="margin-top:12px; color:rgba(111,85,97,.78); font-weight:900; font-size:14px;">
              (웹캠 권한 요청이 뜨면 허용을 눌러주세요)
            </div>
          </div>
        </div>
      </section>

      <!-- INFO -->
      <section class="screen" id="screenInfo">
        <div class="panel infoCard">
          <div class="infoBox">
            <h2>촬영 안내</h2>
            <p>
              <b>10초마다</b> 사진을 한 장씩 찍습니다.<br/>
              총 <b>4장</b> 촬영 후 저장할 수 있어요.
            </p>
            <div class="infoTimer" id="infoTimer">3</div>
          </div>
        </div>
      </section>

      <!-- SHOOT -->
      <section class="screen" id="screenShoot">
        <div class="shootGrid">
          <div class="videoWrap" id="videoWrap">
            <video id="video" playsinline autoplay muted></video>
            <div class="flash" id="flash"></div>

            <div class="hud">
              <div class="hudTop">
                <div class="pill" id="pillStep">촬영 1 / 4</div>
                <div class="pill" id="pillMsg">10초 뒤 촬영</div>
              </div>
              <div class="count" id="countdown">10</div>
            </div>
            <div class="toast" id="toast">안내</div>
          </div>

          <div class="side">
            <div class="thumbPanel">
              <div class="thumbTitle">미리보기</div>
              <div class="thumbGrid" id="thumbGrid">
                <div class="thumb" data-i="0">1번</div>
                <div class="thumb" data-i="1">2번</div>
                <div class="thumb" data-i="2">3번</div>
                <div class="thumb" data-i="3">4번</div>
              </div>
            </div>

            <div class="btnRow">
              <button class="cta danger" id="btnCancel" type="button">취소</button>
              <button class="cta ghost" id="btnRetake" type="button" disabled>전체 다시찍기</button>
            </div>
          </div>
        </div>
      </section>

      <!-- RESULT -->
      <section class="screen" id="screenResult">
        <div class="resultGrid">
          <div class="stage">
            <div class="frame" id="frame">
              <div class="slot" id="slot1"><img alt=""></div>
              <div class="slot" id="slot2"><img alt=""></div>
              <div class="slot" id="slot3"><img alt=""></div>
              <div class="slot" id="slot4"><img alt=""></div>
            </div>
          </div>

          <div class="infoPanel">
            <h2>최종본</h2>
            <p>프레임이 적용된 최종본을 저장할 수 있어요.</p>

            <div class="btnRow" style="margin-top:8px;">
              <button class="cta ghost" id="btnBack" type="button">다시 찍기</button>
              <button class="cta primary" id="btnSave" type="button">PNG로 저장</button>
              <button class="cta danger" id="btnHome" type="button">처음으로</button>
            </div>

            <div style="margin-top:auto; color:rgba(111,85,97,.78); font-weight:900; font-size:14px;">
              저장이 안 되면 브라우저 다운로드 차단을 확인해주세요.
            </div>
          </div>
        </div>
      </section>

      <canvas id="exportCanvas"></canvas>
    </div>
  </div>

  <script>
    // ===== 화면 전환 =====
    const statusEl = document.getElementById('status');
    const screens = {
      start: document.getElementById('screenStart'),
      info: document.getElementById('screenInfo'),
      shoot: document.getElementById('screenShoot'),
      result: document.getElementById('screenResult'),
    };
    function show(name){
      Object.values(screens).forEach(s => s.classList.remove('active'));
      screens[name].classList.add('active');
      const label = name === 'start' ? '대기' : name === 'info' ? '안내' : name === 'shoot' ? '촬영 중' : '최종본';
      statusEl.innerHTML = `<span class="dot"></span>${label}`;
    }

    // ===== DOM =====
    const tapToStart = document.getElementById('tapToStart');
    const btnStart = document.getElementById('btnStart');
    const infoTimerEl = document.getElementById('infoTimer');

    const video = document.getElementById('video');
    const countdownEl = document.getElementById('countdown');
    const pillStep = document.getElementById('pillStep');
    const pillMsg  = document.getElementById('pillMsg');

    const btnCancel = document.getElementById('btnCancel');
    const btnRetake = document.getElementById('btnRetake');
    const btnBack   = document.getElementById('btnBack');
    const btnSave   = document.getElementById('btnSave');
    const btnHome   = document.getElementById('btnHome');

    const flashEl = document.getElementById('flash');
    const videoWrap = document.getElementById('videoWrap');
    const toastEl = document.getElementById('toast');

    const thumbs = [...document.querySelectorAll('.thumb')];
    const slotImgs = [
      document.querySelector('#slot1 img'),
      document.querySelector('#slot2 img'),
      document.querySelector('#slot3 img'),
      document.querySelector('#slot4 img'),
    ];

    const frameEl = document.getElementById('frame');
    const slotEls = [
      document.getElementById('slot1'),
      document.getElementById('slot2'),
      document.getElementById('slot3'),
      document.getElementById('slot4'),
    ];
    const exportCanvas = document.getElementById('exportCanvas');

    // ===== 상태 =====
    let stream = null;
    let shots = [null,null,null,null];
    let aborter = null;
    let running = false;

    const INTERVAL_SEC = 10;
    const TOTAL_SHOTS = 4;

    // ===== 유틸 =====
    const sleep = (ms) => new Promise(r=>setTimeout(r, ms));
    function setCountdownVisible(v){ countdownEl.classList.toggle('show', v); }
    function setCountdownText(t){ countdownEl.textContent = String(t); }

    function toast(msg, ms=900){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>toastEl.classList.remove('show'), ms);
    }

    // ===== TTS (태블릿에서 안정적으로: 필요할 때만 speak) =====
    let ttsEnabled = true;
    function speak(text){
      if(!ttsEnabled) return;
      if(!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ko-KR';
      u.rate = 1.0;
      u.pitch = 1.0;
      u.volume = 1.0;
      window.speechSynthesis.cancel(); // 겹침 방지
      window.speechSynthesis.speak(u);
    }

    function setThumb(i){
      const el = thumbs[i];
      el.innerHTML = '';
      if(!shots[i]){ el.textContent = `${i+1}번`; return; }
      const im = new Image();
      im.src = shots[i];
      el.appendChild(im);
    }

    function resetShots(){
      shots = Array(TOTAL_SHOTS).fill(null);
      for(let i=0;i<TOTAL_SHOTS;i++){
        setThumb(i);
        slotImgs[i].removeAttribute('src');
      }
      btnRetake.disabled = true;
    }

    function updateResultSlots(){
      for(let i=0;i<TOTAL_SHOTS;i++){
        if(shots[i]) slotImgs[i].src = shots[i];
      }
    }

    // ✅ 웹캠 오류 최소화: 가능한 큰 해상도 + 전면 카메라
    async function openCamera(){
      const constraints = {
        video: {
          facingMode: "user",
          width: { ideal: 1920 },
          height:{ ideal: 1080 }
        },
        audio: false
      };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
      // videoWidth가 0인 상태로 캡처되는 오류 방지
      await waitForVideoReady();
    }

    function closeCamera(){
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      video.srcObject = null;
    }

    async function waitForVideoReady(){
      const start = performance.now();
      while((video.videoWidth === 0 || video.videoHeight === 0) && performance.now()-start < 2500){
        await sleep(50);
      }
      if(video.videoWidth === 0) throw new Error('카메라 영상 준비 실패');
    }

    // ===== 찰칵 효과 =====
    let audioCtx = null;
    function clickBeep(){
      try{
        audioCtx ||= new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'triangle';
        o.frequency.value = 880;
        g.gain.value = 0.0001;
        o.connect(g); g.connect(audioCtx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.14, audioCtx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.12);
        o.stop(audioCtx.currentTime + 0.13);
      }catch(e){}
    }
    function shutterFX(){
      flashEl.classList.remove('on');
      void flashEl.offsetWidth;
      flashEl.classList.add('on');
      videoWrap.animate(
        [{ transform:'scale(1)' }, { transform:'scale(1.015)' }, { transform:'scale(1)' }],
        { duration: 220, easing:'ease-out' }
      );
      clickBeep();
    }

    // ===== 캡처 (안정/고정 비율: 4:3 중앙 크롭 + 미러링) =====
    function captureFrame(){
      const vw = video.videoWidth;
      const vh = video.videoHeight;

      // 저장 품질(태블릿에서도 무난)
      const targetW = 1400;
      const targetH = 1050;

      const srcAspect = vw / vh;
      const dstAspect = targetW / targetH;

      let sx=0, sy=0, sw=vw, sh=vh;
      if(srcAspect > dstAspect){
        sw = Math.round(vh * dstAspect);
        sx = Math.round((vw - sw)/2);
      }else{
        sh = Math.round(vw / dstAspect);
        sy = Math.round((vh - sh)/2);
      }

      const c = document.createElement('canvas');
      c.width = targetW; c.height = targetH;
      const ctx = c.getContext('2d', { alpha:false });

      ctx.save();
      ctx.translate(targetW, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, targetW, targetH);
      ctx.restore();

      return c.toDataURL('image/jpeg', 0.92);
    }

    // ===== 촬영 루프 =====
    async function run10sIntervalShoot(){
      if(running) return;
      running = true;
      btnRetake.disabled = true;

      aborter = new AbortController();
      const signal = aborter.signal;

      try{
        for(let i=0;i<TOTAL_SHOTS;i++){
          if(signal.aborted) throw new Error('aborted');

          pillStep.textContent = `촬영 ${i+1} / ${TOTAL_SHOTS}`;
          toast(`${i+1}번째 촬영 준비`, 900);

          // 중간 안내 TTS (과하지 않게)
          speak(`${i+1}번째 사진, 10초 후 촬영합니다.`);

          for(let t=INTERVAL_SEC; t>=1; t--){
            if(signal.aborted) throw new Error('aborted');
            pillMsg.textContent = `${t}초 뒤 촬영`;
            setCountdownText(t);
            setCountdownVisible(true);

            // 3,2,1만 음성으로
            if(t <= 3) speak(String(t));

            await sleep(1000);
          }

          setCountdownVisible(false);
          pillMsg.textContent = '찰칵!';
          toast('찰칵!', 650);
          speak('찰칵');

          shutterFX();
          await sleep(70);

          shots[i] = captureFrame();
          setThumb(i);

          await sleep(320);
        }

        pillMsg.textContent = '촬영 완료';
        toast('촬영 완료! 최종본을 확인하세요.', 1200);
        speak('촬영이 완료되었습니다. 최종본을 확인하고 저장하세요.');

        btnRetake.disabled = false;

        updateResultSlots();
        show('result');
      } finally {
        running = false;
      }
    }

    function cancelShoot(){
      if(aborter) aborter.abort();
      aborter = null;
      running = false;
    }

    // ===== 안내 화면(3초) =====
    async function showInfoThenShoot(){
      show('info');
      speak('촬영을 시작합니다. 10초마다 4장을 자동으로 촬영합니다.');

      for(let t=3; t>=1; t--){
        infoTimerEl.textContent = String(t);
        await sleep(700);
      }
      infoTimerEl.textContent = 'START';
      await sleep(400);

      show('shoot');
      try{
        await openCamera();
      }catch(e){
        alert('웹캠 권한이 필요하거나 HTTPS/localhost가 아닐 수 있어요.\n\n' + e.message);
        show('start');
        return;
      }
      run10sIntervalShoot();
    }

    // ===== PNG 합성/저장 (DOM 슬롯 기반: 저장과 화면이 동일하게 맞음) =====
    function loadImage(src){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('image load fail'));
        img.src = src;
      });
    }

    function drawCover(ctx, img, dx, dy, dw, dh){
      const iw = img.width, ih = img.height;
      const ir = iw/ih, dr = dw/dh;

      let sx=0, sy=0, sw=iw, sh=ih;
      if(ir > dr){
        sw = Math.round(ih * dr);
        sx = Math.round((iw - sw)/2);
      }else{
        sh = Math.round(iw / dr);
        sy = Math.round((ih - sh)/2);
      }
      ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh);
    }

    function getSlotRectsFromDOM(tplW, tplH){
      const frameR = frameEl.getBoundingClientRect();
      const sx = tplW / frameR.width;
      const sy = tplH / frameR.height;

      return slotEls.map(el=>{
        const r = el.getBoundingClientRect();
        const x = Math.round((r.left - frameR.left) * sx);
        const y = Math.round((r.top  - frameR.top)  * sy);
        const w = Math.round(r.width  * sx);
        const h = Math.round(r.height * sy);
        return {x,y,w,h};
      });
    }

    async function exportPNG(){
      if(!shots.every(Boolean)){
        alert('4장 모두 촬영되어야 저장할 수 있어요.');
        return;
      }

      const framePath = getComputedStyle(document.documentElement)
        .getPropertyValue('--frame-url').trim().replace(/^"|"$/g,'');

      let tpl;
      try{
        tpl = await loadImage(framePath);
      }catch(e){
        alert('프레임 이미지를 못 찾았어요. template.png 파일이 같은 폴더에 있는지 확인해줘.');
        return;
      }

      exportCanvas.width = tpl.width;
      exportCanvas.height = tpl.height;
      const ctx = exportCanvas.getContext('2d');

      ctx.drawImage(tpl, 0, 0);

      const imgs = await Promise.all(shots.map(s => loadImage(s)));
      const rects = getSlotRectsFromDOM(tpl.width, tpl.height);

      for(let i=0;i<TOTAL_SHOTS;i++){
        const r = rects[i];
        drawCover(ctx, imgs[i], r.x, r.y, r.w, r.h);
      }

      const blob = await new Promise(res => exportCanvas.toBlob(res, 'image/png'));
      if(!blob){ alert('저장 실패(브라우저 제한)'); return; }

      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = `wedding_4cut_${Date.now()}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      speak('저장을 시작합니다.');
      toast('PNG 저장 완료!', 1100);
    }

    // ===== 시작 =====
    async function startFlow(){
      resetShots();
      await showInfoThenShoot();
    }

    // startCard 전체 클릭 + 버튼 클릭 모두 시작
    tapToStart.addEventListener('click', startFlow);
    btnStart.addEventListener('click', (e)=>{ e.stopPropagation(); startFlow(); });
    tapToStart.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); startFlow(); }
    });

    // ===== 버튼 =====
    btnCancel.addEventListener('click', () => {
      cancelShoot();
      closeCamera();
      speak('촬영을 취소했습니다.');
      show('start');
    });

    btnRetake.addEventListener('click', () => {
      cancelShoot();
      resetShots();
      speak('다시 촬영을 시작합니다.');
      run10sIntervalShoot();
    });

    btnBack.addEventListener('click', async () => {
      cancelShoot();
      resetShots();
      show('shoot');
      try{
        if(!stream) await openCamera();
        speak('다시 촬영을 시작합니다.');
        run10sIntervalShoot();
      }catch(e){
        alert('웹캠을 다시 열 수 없어요.\n\n' + e.message);
        closeCamera();
        show('start');
      }
    });

    btnSave.addEventListener('click', exportPNG);

    btnHome.addEventListener('click', () => {
      cancelShoot();
      closeCamera();
      resetShots();
      speak('처음 화면으로 돌아갑니다.');
      show('start');
    });

    // 초기
    resetShots();
    show('start');
  </script>
</body>
</html>
