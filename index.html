<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>O.cut - 오늘 네컷</title>
  <style>
    :root{
      /* ✅ 연한 핑크 키오스크 톤 */
      --bg1:#fff4f8;
      --bg2:#ffffff;
      --card: rgba(255,255,255,.88);
      --stroke:#ffd3e5;
      --text:#2b1b22;
      --muted:#7a5b68;

      --pink:#ff5aa8;
      --pink2:#ff9ac7;

      --shadow: 0 18px 60px rgba(31,15,24,.10);
      --r:22px;

      /* 템플릿 파일명(같은 폴더에 있어야 함) */
      --t1:"template1.png";
      --t2:"template2.png";
      --t3:"template3.png";
      --t4:"template4.png";
      --t5:"template5.png";
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 25% 15%, rgba(255,154,199,.28) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(1200px 900px at 80% 85%, rgba(255,90,168,.18) 0%, rgba(255,255,255,0) 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
      touch-action: manipulation;
    }

    /* 앱 레이아웃 */
    .app{height:100dvh; width:100vw; display:flex; flex-direction:column;}
    .topbar{
      height:72px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      background: linear-gradient(90deg, rgba(255,90,168,.14), rgba(255,255,255,.92));
      border-bottom:1px solid rgba(255,211,229,.95);
      backdrop-filter: blur(10px);
      flex:0 0 auto;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:1000; letter-spacing:-.6px;
    }
    .brand .dotlogo{
      width:14px; height:14px; border-radius:7px;
      background: radial-gradient(circle at 30% 30%, #fff 0%, #ffd2e7 40%, var(--pink) 100%);
      box-shadow: 0 0 0 10px rgba(255,90,168,.10);
    }
    .brandTitle{font-size:16px; line-height:1.0;}
    .brandSub{font-size:12px; color:rgba(122,91,104,.90); font-weight:950; margin-top:3px;}
    .status{
      display:flex; align-items:center; gap:8px;
      color: rgba(122,91,104,.92);
      font-size:14px; font-weight:950;
    }
    .status .live{
      width:9px; height:9px; border-radius:99px;
      background: rgba(255,90,168,.85);
      box-shadow: 0 0 0 7px rgba(255,90,168,.12);
    }

    .main{flex:1; min-height:0; padding:14px;}
    .panel{
      height:100%;
      background: var(--card);
      border:1px solid rgba(255,211,229,.95);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .screen{display:none; height:100%;}
    .screen.active{display:block;}

    /* 버튼 */
    .btn{
      border:none;
      cursor:pointer;
      border-radius: 18px;
      padding:16px 18px;
      font-weight:1000;
      font-size:16px;
      letter-spacing:-.2px;
      user-select:none;
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:active{transform: translateY(1px);}
    .btn.primary{
      background: linear-gradient(180deg, rgba(255,90,168,.98), rgba(255,154,199,.98));
      color:#fff;
      box-shadow: 0 14px 34px rgba(255,90,168,.18);
    }
    .btn.ghost{
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,90,168,.26);
      color:var(--text);
    }
    .btn.danger{
      background: rgba(255,90,168,.10);
      border:1px solid rgba(255,90,168,.22);
      color:var(--text);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none;}

    /* 홈 */
    .home{
      height:100%;
      display:grid;
      place-items:center;
      padding:22px;
      background:
        radial-gradient(1100px 820px at 70% 22%, rgba(255,154,199,.25) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(1100px 820px at 24% 78%, rgba(255,90,168,.14) 0%, rgba(255,255,255,0) 60%);
    }
    .homeInner{width:min(860px, 96vw); text-align:center;}
    .homeTitle{
      margin:0;
      font-size: clamp(44px, 7vw, 86px);
      line-height:1.0;
      letter-spacing:-2px;
      font-weight:1000;
    }
    .homeSub{
      margin:14px 0 0;
      color: rgba(122,91,104,.92);
      font-weight:950;
      font-size: clamp(15px, 2.2vw, 22px);
      letter-spacing:-.3px;
    }
    .homeHint{
      margin:18px auto 0;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:12px 16px;
      border-radius:999px;
      background: rgba(255,90,168,.10);
      border:1px solid rgba(255,211,229,.95);
      font-weight:1000;
      font-size: clamp(14px, 1.9vw, 18px);
    }
    .pulse{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,90,168,.9);
      box-shadow: 0 0 0 0 rgba(255,90,168,.35);
      animation: pulse 1.4s infinite;
    }
    @keyframes pulse{
      0%{box-shadow: 0 0 0 0 rgba(255,90,168,.35);}
      70%{box-shadow: 0 0 0 14px rgba(255,90,168,0);}
      100%{box-shadow: 0 0 0 0 rgba(255,90,168,0);}
    }

    .homeBtns{
      margin-top:22px;
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .homeBtns .btn{min-width: 220px; font-size:18px; padding:18px 20px;}

    /* 안내 */
    .guide{
      height:100%;
      display:grid;
      place-items:center;
      padding:22px;
      background:
        radial-gradient(1200px 900px at 20% 22%, rgba(255,154,199,.22) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(1200px 900px at 80% 78%, rgba(255,90,168,.12) 0%, rgba(255,255,255,0) 60%);
    }
    .guideBox{
      width:min(900px, 96vw);
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,211,229,.95);
      border-radius: 22px;
      padding: 22px;
      box-shadow: 0 18px 55px rgba(31,15,24,.08);
      text-align:left;
    }
    .guideTitle{
      margin:0;
      font-size: clamp(22px, 2.8vw, 34px);
      letter-spacing:-1px;
      font-weight:1000;
    }
    .guideText{
      margin:10px 0 0;
      color: rgba(122,91,104,.92);
      font-weight:900;
      font-size: clamp(15px, 2.0vw, 18px);
      line-height:1.7;
    }
    .guideTimer{
      margin-top:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .bigCount{
      font-weight:1000;
      font-size: clamp(40px, 6vw, 70px);
      letter-spacing:-2px;
    }

    /* 촬영 */
    .shootGrid{
      height:100%;
      display:grid;
      grid-template-columns: 1.35fr .75fr;
      gap:14px;
      padding:14px;
    }
    @media (max-width: 980px){
      .shootGrid{grid-template-columns:1fr;}
    }
    .videoWrap{
      border-radius: 20px;
      overflow:hidden;
      border:1px solid rgba(255,211,229,.95);
      background:#000;
      position:relative;
      min-height:0;
      height:100%;
      box-shadow: 0 18px 55px rgba(31,15,24,.08);
    }
    video{
      width:100%;
      height:100%;
      display:block;
      object-fit:cover;
      transform: scaleX(-1);
    }
    .flash{position:absolute; inset:0; background:#fff; opacity:0; pointer-events:none; z-index:3;}
    .flash.on{ animation: flash 240ms ease-out; }
    @keyframes flash{ 0%{opacity:0} 10%{opacity:.95} 100%{opacity:0} }

    .hud{position:absolute; inset:0; pointer-events:none; z-index:4;}
    .hudTop{position:absolute; left:12px; top:12px; display:flex; gap:10px; flex-wrap:wrap;}
    .pill{
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.82);
      border:1px solid rgba(255,211,229,.95);
      color: rgba(43,27,34,.92);
      font-size:14px;
      font-weight:1000;
      letter-spacing:-.2px;
    }
    .count{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size: clamp(70px, 12vw, 140px);
      font-weight:1000;
      color:#fff;
      text-shadow: 0 10px 70px rgba(0,0,0,.70);
      opacity:0;
      transform: scale(.96);
      transition: opacity .12s ease, transform .12s ease;
    }
    .count.show{opacity:1; transform: scale(1);}

    .toast{
      position:absolute;
      left:50%; bottom:16px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,211,229,.95);
      border-radius:999px;
      padding:12px 14px;
      font-weight:1000;
      letter-spacing:-.2px;
      box-shadow: 0 18px 55px rgba(31,15,24,.10);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:5;
      font-size:14px;
      white-space:nowrap;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-6px);}

    .side{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height: 260px;
    }
    .card{
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,211,229,.95);
      border-radius: 20px;
      padding:12px;
      box-shadow: 0 18px 55px rgba(31,15,24,.06);
    }
    .cardTitle{
      font-weight:1000;
      letter-spacing:-.4px;
      margin-bottom:10px;
      font-size: 15px;
    }
    .thumbGrid{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .thumb{
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,211,229,.95);
      background: linear-gradient(180deg, #fff, #ffeaf5);
      aspect-ratio: 4/3;
      display:flex; align-items:center; justify-content:center;
      color: rgba(122,91,104,.85);
      font-weight:1000;
      font-size: 14px;
      text-align:center;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}

    .btnRow{display:flex; gap:10px; flex-wrap:wrap;}
    .btnRow .btn{flex:1; min-width: 150px;}

    /* 편집(필터/프레임/문구) */
    .editGrid{
      height:100%;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      padding:14px;
    }
    @media (max-width: 980px){ .editGrid{grid-template-columns:1fr;} }

    .previewStage{
      border-radius: 20px;
      overflow:hidden;
      border:1px solid rgba(255,211,229,.95);
      background: rgba(255,255,255,.92);
      box-shadow: 0 18px 55px rgba(31,15,24,.08);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:12px;
      min-height: 260px;
    }
    .previewCanvas{
      border-radius: 18px;
      border:1px solid rgba(255,211,229,.95);
      background:#fff;
      box-shadow: 0 18px 70px rgba(31,15,24,.10);
      /* ✅ 비율 찌그러짐 방지: JS에서 width/height 맞춰줌 */
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
    }

    .seg{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .chip{
      border:1px solid rgba(255,90,168,.22);
      background: rgba(255,255,255,.92);
      border-radius: 999px;
      padding:10px 12px;
      font-weight:1000;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap:8px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .chip:active{transform: translateY(1px);}
    .chip.active{
      border-color: rgba(255,90,168,.55);
      background: rgba(255,90,168,.10);
    }

    /* 프레임 선택: 실제 템플릿 이미지 썸네일로 표시 */
    .frameGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .frameBtn{
      border:1px solid rgba(255,211,229,.95);
      border-radius: 16px;
      background:#fff;
      overflow:hidden;
      padding:0;
      cursor:pointer;
      box-shadow: 0 10px 30px rgba(31,15,24,.06);
      transition: transform .12s ease, filter .12s ease, border-color .12s ease;
      aspect-ratio: 3/4;
      position:relative;
    }
    .frameBtn:active{transform: translateY(1px);}
    .frameBtn img{width:100%; height:100%; object-fit:cover; display:block;}
    .frameBtn.active{
      border-color: rgba(255,90,168,.60);
      outline: 3px solid rgba(255,90,168,.18);
    }
    .frameBadge{
      position:absolute; left:10px; top:10px;
      background: rgba(255,255,255,.90);
      border:1px solid rgba(255,211,229,.95);
      padding:6px 10px;
      border-radius: 999px;
      font-weight:1000;
      font-size:12px;
      color: rgba(43,27,34,.92);
    }

    /* 문구 */
    .field{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    input[type="text"]{
      flex:1;
      min-width: 180px;
      border-radius: 14px;
      border:1px solid rgba(255,211,229,.95);
      padding:12px 12px;
      font-weight:900;
      outline:none;
      font-size:14px;
      background: rgba(255,255,255,.96);
    }
    input[type="text"]:disabled{opacity:.65;}

    .smallNote{
      margin-top:10px;
      color: rgba(122,91,104,.86);
      font-weight:900;
      font-size:12px;
      line-height:1.6;
    }

    .err{
      color: rgba(122,91,104,.86);
      font-weight:900;
      font-size:12px;
      margin-top:10px;
    }

    canvas{display:none;}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <span class="dotlogo"></span>
        <div>
          <div class="brandTitle">오늘 네컷</div>
          <div class="brandSub">O.cut</div>
        </div>
      </div>
      <div class="status" id="status"><span class="live"></span>대기</div>
    </div>

    <div class="main">
      <div class="panel">

        <!-- HOME -->
        <section class="screen active" id="screenHome">
          <div class="home" id="tapHome" role="button" tabindex="0" aria-label="클릭하여 시작">
            <div class="homeInner">
              <h1 class="homeTitle">O.cut<br/>오늘 네컷</h1>
              <p class="homeSub">클릭하시면 시작됩니다.</p>
              <div class="homeHint"><span class="pulse"></span>화면을 터치(클릭)하세요</div>

              <div class="homeBtns">
                <button class="btn primary" id="btnStart" type="button">시작</button>
                <button class="btn ghost" id="btnTtsToggle" type="button">TTS: 켬</button>
              </div>

              <div class="smallNote">
                웹캠 권한 요청이 뜨면 허용해주세요.
              </div>
            </div>
          </div>
        </section>

        <!-- GUIDE -->
        <section class="screen" id="screenGuide">
          <div class="guide">
            <div class="guideBox">
              <h2 class="guideTitle">촬영 방법 안내</h2>
              <div class="guideText">
                • 10초마다 사진을 1장씩 촬영합니다.<br/>
                • 총 4장 촬영 후, 필터/프레임/문구를 설정하고 저장합니다.<br/>
                • 촬영 중에는 화면을 가리지 말고, 카메라를 정면으로 봐주세요.
              </div>

              <div class="guideTimer">
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                  <div class="bigCount" id="guideCount">8</div>
                  <div style="font-weight:1000; color:rgba(122,91,104,.92);">초 후 촬영을 시작합니다</div>
                </div>
                <div class="btnRow" style="margin-left:auto;">
                  <button class="btn danger" id="btnGuideCancel" type="button">취소</button>
                  <button class="btn primary" id="btnGuideSkip" type="button">바로 시작</button>
                </div>
              </div>

              <div class="err" id="guideErr" style="display:none;">
                오류가 반복되면 관리자에게 문의하세요.
              </div>
            </div>
          </div>
        </section>

        <!-- SHOOT -->
        <section class="screen" id="screenShoot">
          <div class="shootGrid">
            <div class="videoWrap" id="videoWrap">
              <video id="video" playsinline autoplay muted></video>
              <div class="flash" id="flash"></div>

              <div class="hud">
                <div class="hudTop">
                  <div class="pill" id="pillStep">촬영 1 / 4</div>
                  <div class="pill" id="pillMsg">10초 뒤 촬영</div>
                </div>
                <div class="count" id="countdown">10</div>
              </div>
              <div class="toast" id="toast">안내</div>
            </div>

            <div class="side">
              <div class="card">
                <div class="cardTitle">미리보기(촬영본)</div>
                <div class="thumbGrid" id="thumbGrid">
                  <div class="thumb" data-i="0">1</div>
                  <div class="thumb" data-i="1">2</div>
                  <div class="thumb" data-i="2">3</div>
                  <div class="thumb" data-i="3">4</div>
                </div>
              </div>

              <div class="card">
                <div class="cardTitle">촬영 제어</div>
                <div class="btnRow">
                  <button class="btn danger" id="btnCancel" type="button">취소</button>
                  <button class="btn ghost" id="btnRetake" type="button" disabled>전체 다시찍기</button>
                </div>
              </div>

              <div class="err">
                오류가 반복되면 관리자에게 문의하세요.
              </div>
            </div>
          </div>
        </section>

        <!-- EDIT (필터/프레임/문구) -->
        <section class="screen" id="screenEdit">
          <div class="editGrid">
            <div class="previewStage">
              <canvas id="previewCanvas" class="previewCanvas"></canvas>
            </div>

            <div class="side" style="padding:0;">
              <div class="card">
                <div class="cardTitle">필터</div>
                <div class="seg" id="filterSeg"></div>
              </div>

              <div class="card">
                <div class="cardTitle">프레임 선택</div>
                <div class="frameGrid" id="frameGrid"></div>
              </div>

              <div class="card">
                <div class="cardTitle">문구</div>
                <div class="field">
                  <button class="btn ghost" id="btnCaptionToggle" type="button">문구: 꺼짐</button>
                  <input type="text" id="captionInput" placeholder="예: 풍산고 짱" disabled />
                </div>
                <div class="smallNote">기본값은 꺼짐입니다. 켠 경우에만 저장 이미지에 적용됩니다.</div>
              </div>

              <div class="card">
                <div class="cardTitle">저장</div>
                <div class="btnRow">
                  <button class="btn ghost" id="btnEditBack" type="button">다시 찍기</button>
                  <button class="btn primary" id="btnSave" type="button">PNG로 저장</button>
                  <button class="btn danger" id="btnHome" type="button">처음으로</button>
                </div>
                <div class="err">오류가 반복되면 관리자에게 문의하세요.</div>
              </div>
            </div>
          </div>
        </section>

        <canvas id="exportCanvas"></canvas>
      </div>
    </div>
  </div>

  <script>
    // ===============================
    // 기본 상수/상태
    // ===============================
    const INTERVAL_SEC = 10;
    const TOTAL_SHOTS = 4;

    // 템플릿 5개 (파일명: template1~5.png)
    const FRAMES = [
      { id:'t1', label:'프레임 1', file: getCSSVar('--t1') },
      { id:'t2', label:'프레임 2', file: getCSSVar('--t2') },
      { id:'t3', label:'프레임 3', file: getCSSVar('--t3') },
      { id:'t4', label:'프레임 4', file: getCSSVar('--t4') },
      { id:'t5', label:'프레임 5', file: getCSSVar('--t5') },
    ];

    // ✅ 슬롯 좌표(템플릿이 동일한 슬롯 구조라는 전제)
    // (네가 처음 쓰던 값 그대로: 2x2, 위/아래)
    // 이 값이 정확해야 "남색 박스"에 딱 맞게 들어감.
    const SLOT_PERCENT = [
      { x: 0.0354, y: 0.1792, w: 0.4639, h: 0.2390 }, // 1 (좌상)
      { x: 0.5074, y: 0.1792, w: 0.4639, h: 0.2390 }, // 2 (우상)
      { x: 0.0354, y: 0.4937, w: 0.4639, h: 0.2390 }, // 3 (좌하)
      { x: 0.5074, y: 0.4937, w: 0.4639, h: 0.2390 }, // 4 (우하)
    ];

    const FILTERS = [
      { id:'none', label:'기본', css:'none' },
      { id:'bw', label:'흑백', css:'grayscale(1) contrast(1.05)' },
      { id:'sepia', label:'세피아', css:'sepia(0.9) contrast(1.05) saturate(1.1)' },
      { id:'soft', label:'소프트', css:'contrast(0.98) saturate(1.08) brightness(1.05)' },
      { id:'vivid', label:'비비드', css:'contrast(1.12) saturate(1.25)' },
    ];

    let selectedFrameId = 't1';
    let selectedFilterId = 'none';

    // ✅ 문구는 기본 OFF
    let captionEnabled = false;
    let captionText = '';

    let stream = null;
    let shots = [null,null,null,null];
    let running = false;
    let aborter = null;

    // 프레임 이미지 캐시
    const frameCache = new Map(); // file -> HTMLImageElement
    const frameOK = new Map();    // file -> boolean (load ok?)

    // ===============================
    // 화면 전환
    // ===============================
    const statusEl = document.getElementById('status');
    const screens = {
      home:  document.getElementById('screenHome'),
      guide: document.getElementById('screenGuide'),
      shoot: document.getElementById('screenShoot'),
      edit:  document.getElementById('screenEdit'),
    };
    function show(name){
      Object.values(screens).forEach(s=>s.classList.remove('active'));
      screens[name].classList.add('active');
      const label = name === 'home' ? '대기'
        : name === 'guide' ? '안내'
        : name === 'shoot' ? '촬영 중'
        : '편집/저장';
      statusEl.innerHTML = `<span class="live"></span>${label}`;
      if(name === 'edit') requestAnimationFrame(()=>fitPreviewCanvas());
    }

    // ===============================
    // DOM
    // ===============================
    const tapHome = document.getElementById('tapHome');
    const btnStart = document.getElementById('btnStart');
    const btnTtsToggle = document.getElementById('btnTtsToggle');

    const guideCountEl = document.getElementById('guideCount');
    const btnGuideCancel = document.getElementById('btnGuideCancel');
    const btnGuideSkip = document.getElementById('btnGuideSkip');
    const guideErr = document.getElementById('guideErr');

    const video = document.getElementById('video');
    const countdownEl = document.getElementById('countdown');
    const pillStep = document.getElementById('pillStep');
    const pillMsg  = document.getElementById('pillMsg');
    const flashEl = document.getElementById('flash');
    const videoWrap = document.getElementById('videoWrap');
    const toastEl = document.getElementById('toast');

    const btnCancel = document.getElementById('btnCancel');
    const btnRetake = document.getElementById('btnRetake');

    const thumbs = [...document.querySelectorAll('.thumb')];

    const previewCanvas = document.getElementById('previewCanvas');
    const exportCanvas = document.getElementById('exportCanvas');

    const filterSeg = document.getElementById('filterSeg');
    const frameGrid = document.getElementById('frameGrid');

    const btnCaptionToggle = document.getElementById('btnCaptionToggle');
    const captionInput = document.getElementById('captionInput');

    const btnEditBack = document.getElementById('btnEditBack');
    const btnSave = document.getElementById('btnSave');
    const btnHome = document.getElementById('btnHome');

    // ===============================
    // 유틸
    // ===============================
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    function toast(msg, ms=900){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>toastEl.classList.remove('show'), ms);
    }
    function setCountdownVisible(v){ countdownEl.classList.toggle('show', v); }
    function setCountdownText(t){ countdownEl.textContent = String(t); }

    function getCSSVar(name){
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim().replace(/^"|"$/g,'');
    }

    // ===============================
    // ✅ TTS: 끊김/겹침 방지 (큐 방식)
    // ===============================
    let ttsEnabled = true;
    let speakChain = Promise.resolve();

    function speak(text){
      if(!ttsEnabled) return Promise.resolve();
      if(!('speechSynthesis' in window)) return Promise.resolve();

      // 큐에 순서대로 연결
      speakChain = speakChain.then(()=>new Promise((resolve)=>{
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'ko-KR';
        u.rate = 1.0;
        u.pitch = 1.0;
        u.volume = 1.0;

        u.onend = ()=>resolve();
        u.onerror = ()=>resolve();

        // ✅ cancel() 금지: 문장 중간 끊김의 원인
        window.speechSynthesis.speak(u);
      }));
      return speakChain;
    }

    function clearTTSQueue(){
      speakChain = Promise.resolve();
      try{ window.speechSynthesis.cancel(); }catch(e){}
    }

    // ===============================
    // 프레임 로드/검사
    // ===============================
    function loadImage(src){
      return new Promise((resolve, reject)=>{
        const img = new Image();
        img.onload = ()=>resolve(img);
        img.onerror = ()=>reject(new Error('load fail'));
        img.src = src;
      });
    }

    async function preloadFrames(){
      guideErr.style.display = 'none';
      let ok = 0;
      for(const f of FRAMES){
        if(frameCache.has(f.file)) { ok++; continue; }
        try{
          const img = await loadImage(f.file);
          frameCache.set(f.file, img);
          frameOK.set(f.file, true);
          ok++;
        }catch(e){
          frameOK.set(f.file, false);
        }
      }
      // 하나라도 실패하면 안내에 표시
      const allOk = FRAMES.every(f => frameOK.get(f.file) === true);
      if(!allOk) guideErr.style.display = 'block';
      return ok;
    }

    // ===============================
    // 카메라
    // ===============================
    async function openCamera(){
      const constraints = {
        video: {
          facingMode: "user",
          width: { ideal: 1920 },
          height:{ ideal: 1080 }
        },
        audio: false
      };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
      await waitForVideoReady();
    }

    function closeCamera(){
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      video.srcObject = null;
    }

    async function waitForVideoReady(){
      const start = performance.now();
      while((video.videoWidth === 0 || video.videoHeight === 0) && performance.now()-start < 2500){
        await sleep(50);
      }
      if(video.videoWidth === 0) throw new Error('카메라 준비 실패');
    }

    // ===============================
    // 찰칵 효과
    // ===============================
    let audioCtx = null;
    function clickBeep(){
      try{
        audioCtx ||= new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'triangle';
        o.frequency.value = 880;
        g.gain.value = 0.0001;
        o.connect(g); g.connect(audioCtx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.14, audioCtx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.12);
        o.stop(audioCtx.currentTime + 0.13);
      }catch(e){}
    }
    function shutterFX(){
      flashEl.classList.remove('on');
      void flashEl.offsetWidth;
      flashEl.classList.add('on');
      videoWrap.animate(
        [{ transform:'scale(1)' }, { transform:'scale(1.012)' }, { transform:'scale(1)' }],
        { duration: 220, easing:'ease-out' }
      );
      clickBeep();
    }

    // ===============================
    // 촬영 캡처 (4:3 중앙 크롭 + 미러)
    // ===============================
    function captureFrame(){
      const vw = video.videoWidth;
      const vh = video.videoHeight;

      const targetW = 1400;
      const targetH = 1050;

      const srcAspect = vw / vh;
      const dstAspect = targetW / targetH;

      let sx=0, sy=0, sw=vw, sh=vh;
      if(srcAspect > dstAspect){
        sw = Math.round(vh * dstAspect);
        sx = Math.round((vw - sw)/2);
      }else{
        sh = Math.round(vw / dstAspect);
        sy = Math.round((vh - sh)/2);
      }

      const c = document.createElement('canvas');
      c.width = targetW; c.height = targetH;
      const ctx = c.getContext('2d', { alpha:false });

      ctx.save();
      ctx.translate(targetW, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, targetW, targetH);
      ctx.restore();

      return c.toDataURL('image/jpeg', 0.92);
    }

    // ===============================
    // 썸네일/리셋
    // ===============================
    function setThumb(i){
      const el = thumbs[i];
      el.innerHTML = '';
      if(!shots[i]){ el.textContent = String(i+1); return; }
      const im = new Image();
      im.src = shots[i];
      el.appendChild(im);
    }

    function resetShots(){
      shots = Array(TOTAL_SHOTS).fill(null);
      for(let i=0;i<TOTAL_SHOTS;i++) setThumb(i);
      btnRetake.disabled = true;
    }

    // ===============================
    // 촬영 루프
    // ===============================
    async function runIntervalShoot(){
      if(running) return;
      running = true;
      btnRetake.disabled = true;

      aborter = new AbortController();
      const signal = aborter.signal;

      try{
        for(let i=0;i<TOTAL_SHOTS;i++){
          if(signal.aborted) throw new Error('aborted');

          pillStep.textContent = `촬영 ${i+1} / ${TOTAL_SHOTS}`;
          pillMsg.textContent  = `10초 뒤 촬영`;
          toast(`${i+1}번째 촬영 준비`, 850);

          // ✅ 말 끊김 방지: 긴 안내는 1회만, 숫자는 마지막 3초만
          await speak(`${i+1}번째 사진을 촬영합니다.`);

          for(let t=INTERVAL_SEC; t>=1; t--){
            if(signal.aborted) throw new Error('aborted');

            pillMsg.textContent = `${t}초 뒤 촬영`;
            setCountdownText(t);
            setCountdownVisible(true);

            if(t === 3) await speak('3');
            if(t === 2) await speak('2');
            if(t === 1) await speak('1');

            await sleep(1000);
          }

          setCountdownVisible(false);
          pillMsg.textContent = '찰칵!';
          toast('찰칵!', 650);
          await speak('찰칵');

          shutterFX();
          await sleep(70);

          shots[i] = captureFrame();
          setThumb(i);

          await sleep(320);
        }

        pillMsg.textContent = '촬영 완료';
        toast('촬영 완료! 편집 화면으로 이동합니다.', 1100);
        await speak('촬영이 완료되었습니다.');

        btnRetake.disabled = false;

        // 촬영 끝나면 편집 화면으로
        closeCamera();
        show('edit');
        renderPreview();
      } finally {
        running = false;
      }
    }

    function cancelShoot(){
      if(aborter) aborter.abort();
      aborter = null;
      running = false;
    }

    // ===============================
    // ✅ 편집 미리보기: 캔버스로 "사진+필터+프레임+문구"를 항상 동일하게 렌더
    // => 필터 화면에서도, 저장에서도 사진이 안 보이는 문제를 같이 해결
    // ===============================
    function drawCover(ctx, img, dx, dy, dw, dh){
      const iw = img.width, ih = img.height;
      const ir = iw/ih, dr = dw/dh;

      let sx=0, sy=0, sw=iw, sh=ih;
      if(ir > dr){
        sw = Math.round(ih * dr);
        sx = Math.round((iw - sw)/2);
      }else{
        sh = Math.round(iw / dr);
        sy = Math.round((ih - sh)/2);
      }
      ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh);
    }

    function getSelectedFilterCSS(){
      return (FILTERS.find(f=>f.id===selectedFilterId)?.css) || 'none';
    }

    async function renderCompositeToCanvas(targetCanvas){
      if(!shots.every(Boolean)) return;

      const frame = FRAMES.find(f=>f.id===selectedFrameId) || FRAMES[0];
      const frameImg = frameCache.get(frame.file);

      if(!frameImg){
        // 프레임이 없으면 저장/미리보기 불가
        return;
      }

      // 템플릿 원본 해상도로 캔버스 설정
      targetCanvas.width  = frameImg.width;
      targetCanvas.height = frameImg.height;

      const ctx = targetCanvas.getContext('2d', { alpha:true });

      // 1) 배경 투명(혹은 흰색) 초기화
      ctx.clearRect(0,0,targetCanvas.width,targetCanvas.height);

      // 2) 사진 4장(필터 적용)
      const imgs = await Promise.all(shots.map(s=>loadImage(s)));
      const rects = SLOT_PERCENT.map(r=>({
        x: Math.round(r.x * targetCanvas.width),
        y: Math.round(r.y * targetCanvas.height),
        w: Math.round(r.w * targetCanvas.width),
        h: Math.round(r.h * targetCanvas.height),
      }));

      // ✅ 남색 박스에 더 꽉 차게: inset 최소화
      const inset = Math.max(3, Math.round(targetCanvas.width * 0.003));

      ctx.save();
      ctx.filter = getSelectedFilterCSS();
      for(let i=0;i<TOTAL_SHOTS;i++){
        const rr = rects[i];
        drawCover(ctx, imgs[i],
          rr.x + inset, rr.y + inset,
          rr.w - inset*2, rr.h - inset*2
        );
      }
      ctx.restore();

      // 3) 프레임을 위에 덮음 (✅ 저장 시 프레임만 보이던 문제의 핵심 해결)
      ctx.drawImage(frameImg, 0, 0);

      // 4) 문구(기본 OFF)
      if(captionEnabled && captionText.trim()){
        const text = captionText.trim();
        const pad = Math.round(targetCanvas.width * 0.02);
        const y = targetCanvas.height - Math.round(targetCanvas.height * 0.06);
        const x = Math.round(targetCanvas.width * 0.50);

        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = `900 ${Math.round(targetCanvas.width * 0.030)}px system-ui, -apple-system, "Noto Sans KR", sans-serif`;

        // 배경 캡슐
        const metrics = ctx.measureText(text);
        const boxW = Math.round(metrics.width + pad*2.2);
        const boxH = Math.round(targetCanvas.width * 0.055);
        const bx = x - Math.round(boxW/2);
        const by = y - Math.round(boxH/2);

        roundRect(ctx, bx, by, boxW, boxH, Math.round(boxH/2));
        ctx.fillStyle = 'rgba(255,255,255,.90)';
        ctx.fill();
        ctx.lineWidth = Math.max(2, Math.round(targetCanvas.width*0.002));
        ctx.strokeStyle = 'rgba(255,211,229,.95)';
        ctx.stroke();

        // 텍스트
        ctx.fillStyle = 'rgba(43,27,34,.92)';
        ctx.fillText(text, x, y);
        ctx.restore();
      }
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    // ✅ 미리보기 캔버스 "찌그러짐" 방지: 컨테이너 기준으로 3:4 비율 유지
    function fitPreviewCanvas(){
      const stage = previewCanvas.parentElement;
      if(!stage) return;

      const r = stage.getBoundingClientRect();
      const pad = 24; // stage padding 고려
      const maxW = Math.max(100, r.width - pad);
      const maxH = Math.max(100, r.height - pad);

      // 템플릿 비율(대부분 1356/2048 ≈ 0.662) -> width/height
      const aspect = 1356/2048;

      let w = maxW;
      let h = w / aspect;
      if(h > maxH){
        h = maxH;
        w = h * aspect;
      }

      previewCanvas.style.width = `${Math.round(w)}px`;
      previewCanvas.style.height = `${Math.round(h)}px`;
    }
    window.addEventListener('resize', ()=>fitPreviewCanvas());

    async function renderPreview(){
      if(!shots.every(Boolean)) return;
      await renderCompositeToCanvas(previewCanvas);
      fitPreviewCanvas();
    }

    // ===============================
    // 저장
    // ===============================
    async function exportPNG(){
      try{
        if(!shots.every(Boolean)){
          alert('촬영이 완료되지 않았습니다.\n\n오류가 반복되면 관리자에게 문의하세요.');
          return;
        }
        const frame = FRAMES.find(f=>f.id===selectedFrameId) || FRAMES[0];
        if(frameOK.get(frame.file) !== true){
          alert('프레임을 불러올 수 없습니다.\n\n오류가 반복되면 관리자에게 문의하세요.');
          return;
        }

        // exportCanvas에 최종 렌더
        await renderCompositeToCanvas(exportCanvas);

        const blob = await new Promise(res => exportCanvas.toBlob(res, 'image/png'));
        if(!blob){
          alert('저장에 실패했습니다.\n\n오류가 반복되면 관리자에게 문의하세요.');
          return;
        }

        const a = document.createElement('a');
        const url = URL.createObjectURL(blob);
        a.href = url;
        a.download = `Ocut_${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        toast('PNG 저장 완료', 1100);
        await speak('저장을 시작합니다.');
      }catch(e){
        alert('처리 중 오류가 발생했습니다.\n\n오류가 반복되면 관리자에게 문의하세요.');
      }
    }

    // ===============================
    // 필터/프레임 UI 만들기
    // ===============================
    function buildFilterUI(){
      filterSeg.innerHTML = '';
      for(const f of FILTERS){
        const el = document.createElement('button');
        el.className = 'chip' + (f.id===selectedFilterId ? ' active' : '');
        el.type = 'button';
        el.textContent = f.label;
        el.addEventListener('click', async ()=>{
          selectedFilterId = f.id;
          [...filterSeg.children].forEach(c=>c.classList.remove('active'));
          el.classList.add('active');
          await renderPreview();
        });
        filterSeg.appendChild(el);
      }
    }

    function buildFrameUI(){
      frameGrid.innerHTML = '';
      FRAMES.forEach((fr, idx)=>{
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'frameBtn' + (fr.id===selectedFrameId ? ' active' : '');
        b.title = fr.label;

        const badge = document.createElement('div');
        badge.className = 'frameBadge';
        badge.textContent = `선택 ${idx+1}`;
        b.appendChild(badge);

        const img = document.createElement('img');
        img.alt = fr.label;
        img.src = fr.file; // ✅ 템플릿 전체 사진 그대로 보여줌
        b.appendChild(img);

        b.addEventListener('click', async ()=>{
          selectedFrameId = fr.id;
          [...frameGrid.children].forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          await renderPreview();
        });

        frameGrid.appendChild(b);
      });
    }

    // ===============================
    // 홈 -> 안내 -> 촬영 시작 흐름
    // ===============================
    async function showGuideThenShoot(){
      show('guide');

      // 프레임 미리 로드(안내 화면에서)
      await preloadFrames();

      // ✅ 안내 화면 "더 길게"
      // 8초 카운트 + TTS(겹침 방지: await)
      let t = 8;
      guideCountEl.textContent = String(t);
      clearTTSQueue();
      await speak('촬영 방법을 안내합니다.');
      await speak('십 초마다 네 장을 자동 촬영합니다.');

      // 카운트다운(말 겹치지 않게 숫자만)
      while(t > 0){
        guideCountEl.textContent = String(t);
        if(t === 3) await speak('3');
        if(t === 2) await speak('2');
        if(t === 1) await speak('1');
        await sleep(1000);
        t--;
      }

      // 바로 촬영 시작
      await startShoot();
    }

    async function startShoot(){
      show('shoot');
      try{
        await openCamera();
      }catch(e){
        alert('웹캠 권한이 필요하거나 HTTPS/localhost가 아닐 수 있습니다.\n\n오류가 반복되면 관리자에게 문의하세요.');
        closeCamera();
        show('home');
        return;
      }
      runIntervalShoot();
    }

    // ===============================
    // 이벤트 바인딩
    // ===============================
    function startFlow(){
      resetShots();
      selectedFrameId = 't1';
      selectedFilterId = 'none';

      captionEnabled = false;
      captionText = '';
      captionInput.value = '';
      captionInput.disabled = true;
      btnCaptionToggle.textContent = '문구: 꺼짐';

      buildFilterUI();
      buildFrameUI();

      showGuideThenShoot();
    }

    tapHome.addEventListener('click', startFlow);
    btnStart.addEventListener('click', (e)=>{ e.stopPropagation(); startFlow(); });
    tapHome.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); startFlow(); }
    });

    btnTtsToggle.addEventListener('click', ()=>{
      ttsEnabled = !ttsEnabled;
      btnTtsToggle.textContent = `TTS: ${ttsEnabled ? '켬' : '끔'}`;
      if(!ttsEnabled) clearTTSQueue();
    });

    btnGuideCancel.addEventListener('click', ()=>{
      clearTTSQueue();
      show('home');
    });

    btnGuideSkip.addEventListener('click', async ()=>{
      clearTTSQueue();
      await startShoot();
    });

    btnCancel.addEventListener('click', ()=>{
      cancelShoot();
      closeCamera();
      clearTTSQueue();
      show('home');
    });

    btnRetake.addEventListener('click', ()=>{
      cancelShoot();
      resetShots();
      clearTTSQueue();
      startShoot();
    });

    btnCaptionToggle.addEventListener('click', async ()=>{
      captionEnabled = !captionEnabled;
      btnCaptionToggle.textContent = `문구: ${captionEnabled ? '켜짐' : '꺼짐'}`;
      captionInput.disabled = !captionEnabled;
      captionText = captionInput.value || '';
      await renderPreview();
    });

    captionInput.addEventListener('input', async ()=>{
      captionText = captionInput.value || '';
      await renderPreview();
    });

    btnEditBack.addEventListener('click', ()=>{
      clearTTSQueue();
      resetShots();
      show('home');
    });

    btnSave.addEventListener('click', exportPNG);

    btnHome.addEventListener('click', ()=>{
      clearTTSQueue();
      resetShots();
      show('home');
    });

    // 초기
    resetShots();
    buildFilterUI();
    buildFrameUI();
    show('home');
  </script>
</body>
</html>
